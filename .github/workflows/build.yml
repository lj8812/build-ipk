name: ç¼–è¯‘ OpenClash æ’ä»¶ï¼ˆå«å†…æ ¸ï¼‰

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡å¹³å°/æ¶æ„ (å¦‚x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrtå›ºä»¶ç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core_version:
        description: 'Mihomoå†…æ ¸ç‰ˆæœ¬ (å¸¦vå‰ç¼€)'
        required: true
        default: 'v1.18.0'
      plugin_branch:
        description: 'æ’ä»¶æºç åˆ†æ”¯'
        required: true
        default: 'master'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev \
          python3 python3-distutils python3-setuptools unzip wget \
          rsync subversion swig time xsltproc zlib1g-dev tree jq

    - name: è®¾ç½® Python ç¯å¢ƒ
      run: |
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        python -m pip install --upgrade pip
        pip install requests

    - name: è®¾ç½®ç›®æ ‡å˜é‡
      id: set_target
      run: |
        # è½¬æ¢æ¶æ„å‘½å
        case "${{ github.event.inputs.target }}" in
          "x86/64")       ARCH="amd64"; TARGET_NAME="x86_64" ;;
          "armvirt/64")   ARCH="armv8"; TARGET_NAME="armvirt" ;;
          "arm64")        ARCH="armv8"; TARGET_NAME="arm64" ;;
          "arm/armv7")    ARCH="armv7"; TARGET_NAME="armv7" ;;
          "mips/mips32")  ARCH="mips"; TARGET_NAME="mips32" ;;
          "mips/mips64")  ARCH="mips64"; TARGET_NAME="mips64" ;;
          "riscv/64")     ARCH="riscv64"; TARGET_NAME="riscv64" ;;
          *)              ARCH="amd64"; TARGET_NAME="generic" ;;
        esac

        TARGET_DASH=$(echo "${{ github.event.inputs.target }}" | sed 's/\//-/g')
        echo "ARCH=$ARCH" >> $GITHUB_ENV
        echo "TARGET_DASH=$TARGET_DASH" >> $GITHUB_ENV
        echo "TARGET_NAME=$TARGET_NAME" >> $GITHUB_ENV

    - name: éªŒè¯å†…æ ¸ç‰ˆæœ¬
      run: |
        VERSION_URL="https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/${{ github.event.inputs.clash_core_version }}"
        RESPONSE=$(curl -s -H "Accept: application/vnd.github.v3+json" -w "%{http_code}" -o /dev/null $VERSION_URL)
        
        if [ "$RESPONSE" -ne 200 ]; then
          echo "::error::æ— æ•ˆçš„ Mihomo ç‰ˆæœ¬: ${{ github.event.inputs.clash_core_version }}"
          echo "å¯ç”¨ç‰ˆæœ¬æŸ¥çœ‹: https://github.com/MetaCubeX/mihomo/releases"
          exit 1
        fi

    - name: ä¸‹è½½å¹¶è§£å‹ OpenWrt SDK
      run: |
        SDK_BASE="https://downloads.openwrt.org/releases/${{ github.event.inputs.firmware_version }}/targets/${{ github.event.inputs.target }}"
        SDK_FILE=$(curl -s $SDK_BASE/ | grep -oP "openwrt-sdk-.*-$TARGET_DASH.*Linux-x86_64.tar.xz" | head -1)
        
        echo "ä¸‹è½½SDK: $SDK_BASE/$SDK_FILE"
        wget --progress=dot:giga "$SDK_BASE/$SDK_FILE" -O openwrt-sdk.tar.xz
        mkdir -p openwrt-sdk
        tar -xJf openwrt-sdk.tar.xz -C openwrt-sdk --strip-components 1
        echo "SDK_PATH=$GITHUB_WORKSPACE/openwrt-sdk" >> $GITHUB_ENV

    - name: å‡†å¤‡æ’ä»¶æºç 
      env:
        PLUGIN_NAME: luci-app-openclash
      run: |
        cd $SDK_PATH
        git clone --depth 1 --branch ${{ github.event.inputs.plugin_branch }} \
          https://github.com/vernesong/OpenClash.git package/$PLUGIN_NAME

        # ä¿®å¤æºç æ ¼å¼
        cd package/$PLUGIN_NAME/$PLUGIN_NAME
        sed -i -e 's/^    /\t/g' -e 's/\r$//' Makefile

        # è·å–æ’ä»¶ç‰ˆæœ¬
        PLUGIN_VERSION=$(make -s -f version.mk 2>/dev/null | grep 'PKG_VERSION' | cut -d '=' -f2)
        echo "PLUGIN_VERSION=${PLUGIN_VERSION:-dev}" >> $GITHUB_ENV

    - name: é¢„ç½®å†…æ ¸æ–‡ä»¶
      run: |
        CORE_DIR="$SDK_PATH/package/$PLUGIN_NAME/$PLUGIN_NAME/files/etc/openclash/core"
        mkdir -p $CORE_DIR
        
        # ä¸‹è½½æœ€æ–°mihomoå†…æ ¸
        CORE_URL="https://github.com/MetaCubeX/mihomo/releases/download/${{ github.event.inputs.clash_core_version }}/mihomo-linux-${{ env.ARCH }}.gz"
        wget -q $CORE_URL -O $CORE_DIR/clash.gz
        gunzip $CORE_DIR/clash.gz
        chmod 755 $CORE_DIR/clash

        # éªŒè¯å†…æ ¸æ–‡ä»¶
        if [ ! -f $CORE_DIR/clash ]; then
          echo "::error::å†…æ ¸ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¶æ„åŒ¹é…"
          exit 1
        fi

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd $SDK_PATH
        echo "CONFIG_TARGET_${{ env.TARGET_NAME }}=y" > .config
        echo "CONFIG_PACKAGE_$PLUGIN_NAME=m" >> .config
        make defconfig

    - name: ç¼–è¯‘æ’ä»¶
      run: |
        cd $SDK_PATH
        make -j$(($(nproc) + 1)) V=s \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          CONFIG_PACKAGE_$PLUGIN_NAME=m

    - name: æ”¶é›†äº§ç‰©
      run: |
        OUTPUT_DIR="$GITHUB_WORKSPACE/output"
        mkdir -p $OUTPUT_DIR
        
        # ä¸»ç¨‹åºåŒ…
        find $SDK_PATH/bin -name "${PLUGIN_NAME}*.ipk" -exec cp {} $OUTPUT_DIR \;
        
        # ä¾èµ–åŒ…
        find $SDK_PATH/bin -name "luci-*-openclash*.ipk" -exec cp {} $OUTPUT_DIR \;
        
        # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        echo "{
          \"target\": \"${{ github.event.inputs.target }}\",
          \"firmware_version\": \"${{ github.event.inputs.firmware_version }}\",
          \"clash_core\": \"${{ github.event.inputs.clash_core_version }}\",
          \"plugin_version\": \"${{ env.PLUGIN_VERSION }}\",
          \"build_time\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"
        }" > $OUTPUT_DIR/build-info.json

    - name: å‘å¸ƒç‰ˆæœ¬
      uses: softprops/action-gh-release@v2
      with:
        files: |
          output/*
          !output/*.json
        tag_name: openclash-${{ github.event.inputs.clash_core_version }}-${{ env.PLUGIN_VERSION }}
        name: OpenClash ${{ github.event.inputs.clash_core_version }}
        body: |
          ### ç¼–è¯‘ä¿¡æ¯
          ğŸ—ï¸ ç›®æ ‡æ¶æ„: `${{ github.event.inputs.target }}`  
          ğŸ“¦ OpenWrtç‰ˆæœ¬: `${{ github.event.inputs.firmware_version }}`  
          âš¡ Mihomoå†…æ ¸: `${{ github.event.inputs.clash_core_version }}`  
          ğŸ§© æ’ä»¶ç‰ˆæœ¬: `${{ env.PLUGIN_VERSION }}`  
          ğŸ•’ ç¼–è¯‘æ—¶é—´: `$(date -u +'%Y-%m-%d %H:%M:%S UTC')`

          ### æ ¡éªŒä¿¡æ¯
          ```json
          $(cat output/build-info.json)
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
