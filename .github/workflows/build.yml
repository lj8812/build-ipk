name: OpenClash AutoBuilder (Stable)

on:
  push:
    paths:
      - '**.yml'
      - '**.yaml'
    branches: [ "main", "master" ]

  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æž¶æž„ (å¦‚ x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core:
        description: 'Mihomoæ ¸å¿ƒç‰ˆæœ¬ (å¸¦vå‰ç¼€)'
        required: true
        default: 'v1.18.0'

env:
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    # ===================== åˆå§‹åŒ–é˜¶æ®µ =====================
    - name: ðŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº
      id: init
      run: |
        # å®šä¹‰è·¯å¾„å˜é‡ï¼ˆæ­£ç¡®ä½¿ç”¨ä¸Šä¸‹æ–‡ï¼‰
        BUILD_DIR="${{ github.workspace }}/openwrt-build"
        CACHE_DIR="${{ runner.temp }}/sdk_cache"
        mkdir -p $BUILD_DIR $CACHE_DIR
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        echo "CACHE_DIR=$CACHE_DIR" >> $GITHUB_ENV

    # ===================== ä¾èµ–å®‰è£… =====================
    - name: ðŸ“¥ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          aria2 xz-utils ccache \
          build-essential git python3 \
          libncurses-dev zlib1g-dev

    # ===================== å‚æ•°é¢„å¤„ç† =====================
    - name: ðŸ” è§£æžè¾“å…¥å‚æ•°
      run: |
        # æž¶æž„å‚æ•°è½¬æ¢ (x86/64 â†’ x86-64)
        FORMATTED_TARGET="${{ inputs.target }}" 
        FORMATTED_TARGET="${FORMATTED_TARGET//\//-}"
        
        # ç‰ˆæœ¬å‚æ•°å¤„ç† (23.05.5 â†’ 23.05)
        FIRMWARE_MAJOR="${{ inputs.firmware_version }}"
        FIRMWARE_MAJOR="${FIRMWARE_MAJOR%.*}"
        
        echo "FORMATTED_TARGET=$FORMATTED_TARGET" >> $GITHUB_ENV
        echo "FIRMWARE_MAJOR=$FIRMWARE_MAJOR" >> $GITHUB_ENV

    # ===================== SDKä¸‹è½½ =====================
    - name: ðŸŒ å¤šæºä¸‹è½½SDK
      env:
        MIRROR_LIST: >
          https://downloads.openwrt.org,
          https://mirror.sjtu.edu.cn/openwrt,
          https://mirrors.tuna.tsinghua.edu.cn/openwrt
      run: |
        # å®šä¹‰æ–‡ä»¶ååŒ¹é…æ¨¡å¼
        FILE_PATTERNS=(
          "openwrt-sdk-${{ inputs.firmware_version }}-${FORMATTED_TARGET}_*"
          "openwrt-sdk-${FIRMWARE_MAJOR}-*-${FORMATTED_TARGET}_*"
        )

        # å¤šçº§ä¸‹è½½å°è¯•
        for mirror in ${MIRROR_LIST//,/ }; do
          for pattern in "${FILE_PATTERNS[@]}"; do
            download_url="${mirror}/releases/${{ inputs.firmware_version }}/targets/${{ inputs.target }}/${pattern}"
            echo "ðŸ”— å°è¯•ä¸‹è½½: ${download_url}"
            
            if aria2c -x8 --retry-wait=15 -o "${CACHE_DIR}/temp.tar.xz" "${download_url}"; then
              if xz -t "${CACHE_DIR}/temp.tar.xz"; then
                mv "${CACHE_DIR}/temp.tar.xz" "${CACHE_DIR}/sdk.tar.xz"
                echo "âœ… ä¸‹è½½éªŒè¯æˆåŠŸ"
                exit 0
              fi
            fi
          done
        done

        # å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆ
        echo "âš ï¸ é•œåƒæºå¤±è´¥ï¼Œå°è¯•GitHubå¤‡ä»½..."
        backup_url="https://ghproxy.com/https://github.com/openwrt/sdk/releases/download/v${{ inputs.firmware_version }}/sdk-${FORMATTED_TARGET}.tar.xz"
        if curl -L "$backup_url" -o "${CACHE_DIR}/sdk.tar.xz" && xz -t "${CACHE_DIR}/sdk.tar.xz"; then
          exit 0
        fi

        echo "::error::æ‰€æœ‰ä¸‹è½½æ–¹å¼å‡å¤±è´¥"
        exit 1

    # ===================== æºç å‡†å¤‡ =====================
    - name: ðŸ’¾ å‡†å¤‡æ’ä»¶æºç 
      run: |
        # è§£åŽ‹SDK
        tar -xJf "${CACHE_DIR}/sdk.tar.xz" -C $BUILD_DIR --strip-components=1
        
        # å…‹éš†æºç 
        cd $BUILD_DIR
        git clone --depth 1 --branch master \
          https://github.com/vernesong/OpenClash package/${PLUGIN_NAME}
        
        # è‡ªåŠ¨ä¿®å¤Makefile
        find package/${PLUGIN_NAME} -name Makefile -exec sed -i 's/^    /\t/g' {} +

    # ===================== ç¼–è¯‘é…ç½® =====================
    - name: âš™ï¸ ç”Ÿæˆç¼–è¯‘é…ç½®
      run: |
        cd $BUILD_DIR
        cat > .config <<EOF
        CONFIG_TARGET_${FORMATTED_TARGET//-/_}=y
        CONFIG_PACKAGE_${PLUGIN_NAME}=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        make defconfig

    # ===================== æ‰§è¡Œç¼–è¯‘ =====================
    - name: ðŸ­ ç¼–è¯‘æ’ä»¶
      run: |
        cd $BUILD_DIR
        make -j$(($(nproc) + 2)) \
          V=sc \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          package/${PLUGIN_NAME}/compile

    # ===================== å‘å¸ƒäº§ç‰© =====================
    - name: ðŸš€ åˆ›å»ºRelease
      uses: softprops/action-gh-release@v2
      with:
        files: |
          $BUILD_DIR/bin/packages/**/*.ipk
        tag_name: openclash-${{ inputs.clash_core }}-$(date +%Y%m%d)
        name: OpenClash ${{ inputs.clash_core }} Build
        body: |
          ### æž„å»ºä¿¡æ¯
          | å‚æ•°          | å€¼                      |
          |---------------|-------------------------|
          | ç›®æ ‡æž¶æž„      | `${{ inputs.target }}`  |
          | OpenWrtç‰ˆæœ¬   | `${{ inputs.firmware_version }}` |
          | æ ¸å¿ƒç‰ˆæœ¬      | `${{ inputs.clash_core }}` |

          ### æ–‡ä»¶æ¸…å•
          ```bash
          $(ls -l $BUILD_DIR/bin/packages/**/*.ipk)
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ===================== é”™è¯¯é€šçŸ¥ =====================
    - name: ðŸš¨ æž„å»ºå¤±è´¥é€šçŸ¥
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸš¨ æž„å»ºå¤±è´¥!\n
              é”™è¯¯æ­¥éª¤: ${{ join(toJson(steps.*.outcome)) }}\n
              å®Œæ•´æ—¥å¿—: ${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          })
