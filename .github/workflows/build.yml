name: OpenClash AutoBuild (Master Branch)

on:
  push:
    paths:
      - '.github/workflows/*.yml'
    branches: [ "master" ]
  
  schedule:
    - cron: '0 12 * * 1'  # æ¯å‘¨ä¸€UTCä¸­åˆ12ç‚¹è‡ªåŠ¨æ„å»º

  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æ¶æ„ (x86/64, arm/armv7ç­‰)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core:
        description: 'Mihomoæ ¸å¿ƒç‰ˆæœ¬ (å¸¦vå‰ç¼€)'
        required: true
        default: 'v1.18.0'

env:
  BUILD_DIR: ${{ github.workspace }}/openwrt-build
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        mkdir -p $BUILD_DIR
        echo "æ„å»ºå¼€å§‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S %Z')"

    - name: ğŸ” è§£æç›®æ ‡æ¶æ„
      run: |
        case "${{ github.event.inputs.target }}" in
          "x86/64")    ARCH="amd64"; TARGET_CFG="x86_64" ;;
          "arm/armv7") ARCH="armv7"; TARGET_CFG="armv7" ;;
          "armvirt/64") ARCH="armv8"; TARGET_CFG="armvirt" ;;
          *)            ARCH="amd64"; TARGET_CFG="generic" ;;
        esac
        echo "ARCH=$ARCH" >> $GITHUB_ENV
        echo "TARGET_CFG=$TARGET_CFG" >> $GITHUB_ENV

    - name: ğŸ“¦ ä¸‹è½½OpenWrt SDK
      run: |
        SDK_PATH="releases/${{ github.event.inputs.firmware_version }}/targets/${{ github.event.inputs.target }}"
        SDK_URL="https://downloads.openwrt.org/$SDK_PATH"
        
        echo "ğŸ” æŸ¥æ‰¾æœ€æ–°SDKæ–‡ä»¶..."
        SDK_FILE=$(curl -sL "$SDK_URL" | grep -oE 'openwrt-sdk-.*?Linux-x86_64\.tar\.xz' | head -1)
        
        echo "ğŸ”— ä¸‹è½½åœ°å€: $SDK_URL/$SDK_FILE"
        curl --retry 3 --retry-delay 10 -L -o sdk.tar.xz "$SDK_URL/$SDK_FILE"
        
        echo "ğŸ”’ éªŒè¯å‹ç¼©åŒ…..."
        xz -t sdk.tar.xz || (echo "::error::æ–‡ä»¶æ ¡éªŒå¤±è´¥"; exit 1)
        
        echo "ğŸ“‚ è§£å‹åˆ° $BUILD_DIR"
        tar -xJf sdk.tar.xz -C $BUILD_DIR --strip-components=1
        rm -f sdk.tar.xz

    - name: ğŸ’¾ è·å–æ’ä»¶æºç 
      run: |
        cd $BUILD_DIR
        echo "â¬‡ï¸ æ­£åœ¨å…‹éš† master åˆ†æ”¯..."
        git clone --depth 1 --branch master \
          https://github.com/vernesong/OpenClash package/$PLUGIN_NAME || {
            echo "::error::ä»“åº“å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ†æ”¯åç§°"
            exit 1
          }
        
        cd package/$PLUGIN_NAME/$PLUGIN_NAME
        echo "ğŸ”§ ä¿®å¤Makefileæ ¼å¼..."
        sed -i 's/^    /\t/g' Makefile
        [ -f "Makefile" ] || { echo "::error::Makefileä¸å­˜åœ¨"; exit 1; }

    - name: âš™ï¸ é¢„ç½®æ ¸å¿ƒæ–‡ä»¶
      run: |
        CORE_DIR="$BUILD_DIR/package/$PLUGIN_NAME/$PLUGIN_NAME/files/etc/openclash/core"
        mkdir -p $CORE_DIR
        
        echo "â¬‡ï¸ ä¸‹è½½mihomoæ ¸å¿ƒ (æ¶æ„: $ARCH)..."
        CORE_URL="https://github.com/MetaCubeX/mihomo/releases/download/${{ github.event.inputs.clash_core }}/mihomo-linux-$ARCH.gz"
        
        if ! curl -sL "$CORE_URL" | gunzip > "$CORE_DIR/clash"; then
          echo "::error::æ ¸å¿ƒä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç‰ˆæœ¬å’Œæ¶æ„åŒ¹é…"
          exit 1
        fi
        chmod 755 "$CORE_DIR/clash"

    - name: ğŸ—ï¸ é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        cat << EOF > .config
        CONFIG_TARGET_${TARGET_CFG}=y
        CONFIG_PACKAGE_${PLUGIN_NAME}=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        make defconfig

    - name: ğŸš€ æ‰§è¡Œç¼–è¯‘
      run: |
        cd $BUILD_DIR
        echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘ (ä½¿ç”¨ $(nproc) çº¿ç¨‹)..."
        make -j$(nproc) V=s \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          package/${PLUGIN_NAME}/compile

    - name: ğŸ“¤ æ•´ç†è¾“å‡ºæ–‡ä»¶
      run: |
        OUTPUT_DIR="${{ github.workspace }}/artifacts"
        mkdir -p $OUTPUT_DIR
        
        # æ”¶é›†æ‰€æœ‰ipkæ–‡ä»¶
        find $BUILD_DIR/bin -name '*.ipk' -exec cp {} $OUTPUT_DIR \;
        
        # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
        cd $OUTPUT_DIR
        sha256sum *.ipk > SHA256SUMS
        echo "æ„å»ºä¿¡æ¯:" > build-info.txt
        echo "ç›®æ ‡æ¶æ„: ${{ github.event.inputs.target }}" >> build-info.txt
        echo "OpenWrtç‰ˆæœ¬: ${{ github.event.inputs.firmware_version }}" >> build-info.txt
        echo "æ ¸å¿ƒç‰ˆæœ¬: ${{ github.event.inputs.clash_core }}" >> build-info.txt
        echo "ç¼–è¯‘æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> build-info.txt

    - name: ğŸš¢ å‘å¸ƒç‰ˆæœ¬
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/*.ipk
          artifacts/SHA256SUMS
          artifacts/build-info.txt
        tag_name: openclash-${{ github.event.inputs.clash_core }}-$(date +%m%d)
        name: OpenClash ${{ github.event.inputs.clash_core }} Build
        body: |
          ### æ„å»ºä¿¡æ¯
          - â€‹**æ¶æ„**: `${{ github.event.inputs.target }}`
          - â€‹**OpenWrtç‰ˆæœ¬**: `${{ github.event.inputs.firmware_version }}`
          - â€‹**æ ¸å¿ƒç‰ˆæœ¬**: `${{ github.event.inputs.clash_core }}`
          - â€‹**ç¼–è¯‘æ—¶é—´**: `$(date -u +"%Y-%m-%dT%H:%M:%SZ")`

          ### å®‰è£…è¯´æ˜
          ```bash
          opkg install luci-app-openclash_*.ipk
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
