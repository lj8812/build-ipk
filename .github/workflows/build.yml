name: OpenClash ç²¾å‡†ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      firmware_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core:
        description: 'Mihomoæ ¸å¿ƒç‰ˆæœ¬'
        required: true
        default: 'v1.18.0'

env:
  PLUGIN_NAME: luci-app-openclash
  TARGET: "x86/64"  # å›ºå®šç›®æ ‡æž¶æž„

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
    # ===================== åˆå§‹åŒ–é˜¶æ®µ =====================
    - name: ðŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº
      run: |
        BUILD_DIR="${{ github.workspace }}/openwrt-build"
        CACHE_DIR="/tmp/sdk_cache"
        mkdir -p $BUILD_DIR $CACHE_DIR
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        echo "CACHE_DIR=$CACHE_DIR" >> $GITHUB_ENV

    # ===================== å®‰è£…å·¥å…·é“¾ =====================
    - name: ðŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          aria2 xz-utils \
          build-essential git python3

    # ===================== ç²¾ç¡®ä¸‹è½½SDK =====================
    - name: ðŸŒ å››çº§ä¿éšœä¸‹è½½
      run: |
        # å›ºå®šå‚æ•°é…ç½®
        FW_VER="${{ inputs.firmware_version }}"
        SAFE_TARGET="x86-64"  # ç¡¬ç¼–ç è½¬æ¢ç»“æžœ
        SDK_FILE="openwrt-sdk-${FW_VER}-${SAFE_TARGET}_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        
        # ä¸‹è½½æºåˆ—è¡¨ï¼ˆä¼˜å…ˆçº§æŽ’åºï¼‰
        DOWNLOAD_SOURCES=(
          "https://downloads.openwrt.org/releases/${FW_VER}/targets/x86/64/${SDK_FILE}"
          "https://mirror.ghproxy.com/https://downloads.openwrt.org/releases/${FW_VER}/targets/x86/64/${SDK_FILE}"
          "https://op.supes.top/${SDK_FILE}"
          "https://mirror.sjtu.edu.cn/openwrt/releases/${FW_VER}/targets/x86/64/${SDK_FILE}"
        )

        # å¤šçº§ä¸‹è½½å°è¯•
        for url in "${DOWNLOAD_SOURCES[@]}"; do
          echo "ðŸ”— å°è¯•ä¸‹è½½: $url"
          
          # ä½¿ç”¨ aria2c ä¸‹è½½ï¼ˆ3æ¬¡é‡è¯•ï¼‰
          if aria2c \
            --max-tries=3 \
            --retry-wait=30 \
            --timeout=600 \
            --allow-overwrite=true \
            --file-allocation=none \
            -d "$CACHE_DIR" \
            -o "$SDK_FILE" \
            "$url"; then

            # ä¸¥æ ¼æ ¡éªŒæ–‡ä»¶
            if xz -T0 -t "$CACHE_DIR/$SDK_FILE"; then
              echo "âœ… ä¸‹è½½éªŒè¯æˆåŠŸ"
              exit 0
            else
              echo "âš ï¸ æ–‡ä»¶æŸåï¼Œåˆ é™¤é‡è¯•..."
              rm -f "$CACHE_DIR/$SDK_FILE"
            fi
          fi
          sleep 10  # é—´éš”10ç§’é‡è¯•
        done

        echo "::error::âŒ æ‰€æœ‰ä¸‹è½½æ–¹å¼å‡å¤±è´¥ï¼è¯·æ‰‹åŠ¨ä¸‹è½½ï¼š"
        echo "https://downloads.openwrt.org/releases/${FW_VER}/targets/x86/64/${SDK_FILE}"
        exit 1

    # ===================== å‡†å¤‡ç¼–è¯‘çŽ¯å¢ƒ =====================
    - name: ðŸ’» è§£åŽ‹SDK
      run: |
        tar -xJf "$CACHE_DIR/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz" \
          -C $BUILD_DIR --strip-components=1

    - name: ðŸ“‚ èŽ·å–æ’ä»¶æºç 
      run: |
        cd $BUILD_DIR
        git clone --depth 1 --branch master \
          https://github.com/vernesong/OpenClash package/$PLUGIN_NAME
        
        # å¼ºåˆ¶ä¿®å¤Makefileæ ¼å¼
        find package/$PLUGIN_NAME -name Makefile -exec sed -i 's/^    /\t/g' {} +

    # ===================== ç¼–è¯‘é…ç½® =====================
    - name: âš™ï¸ ç”Ÿæˆé…ç½®
      run: |
        cd $BUILD_DIR
        cat > .config <<EOF
        CONFIG_TARGET_x86_64=y
        CONFIG_PACKAGE_$PLUGIN_NAME=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        make defconfig

    # ===================== æ‰§è¡Œç¼–è¯‘ =====================
    - name: ðŸ­ å¼€å§‹ç¼–è¯‘
      run: |
        cd $BUILD_DIR
        make -j$(($(nproc) + 2)) \
          V=sc \
          package/$PLUGIN_NAME/compile

    # ===================== å‘å¸ƒç»“æžœ =====================
    - name: ðŸš€ å‘å¸ƒRelease
      uses: softprops/action-gh-release@v2
      with:
        files: |
          $BUILD_DIR/bin/packages/**/*.ipk
        tag_name: openclash-${{ inputs.clash_core }}-$(date +%Y%m%d)
        body: |
          ### ç¼–è¯‘ä¿¡æ¯
          - â€‹**æž¶æž„**: x86/64
          - â€‹**OpenWrtç‰ˆæœ¬**: ${{ inputs.firmware_version }}
          - â€‹**æ ¸å¿ƒç‰ˆæœ¬**: ${{ inputs.clash_core }}
          - â€‹**ç¼–è¯‘æ—¶é—´**: `$(date -u +"%Y-%m-%dT%H:%M:%SZ")`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ===================== é”™è¯¯é€šçŸ¥ =====================
    - name: ðŸš¨ å¤±è´¥é€šçŸ¥
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `â—ï¸ ç¼–è¯‘å¤±è´¥ï¼é”™è¯¯è¯¦æƒ…ï¼š\n
              ${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          })
