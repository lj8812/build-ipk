name: OpenClash Stable Builder

on:
  push:
    paths:
      - '**.yml'
      - '**.yaml'
    branches: [ "main", "master" ]

  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æž¶æž„ (ç¤ºä¾‹: x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core:
        description: 'Mihomoæ ¸å¿ƒç‰ˆæœ¬ (å¸¦vå‰ç¼€)'
        required: true
        default: 'v1.18.0'

env:
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    # ===================== åˆå§‹åŒ–çŽ¯å¢ƒ =====================
    - name: ðŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº
      id: init
      run: |
        BUILD_DIR="${{ github.workspace }}/openwrt-build"
        CACHE_DIR="${{ runner.temp }}/sdk_cache"
        mkdir -p $BUILD_DIR $CACHE_DIR
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        echo "CACHE_DIR=$CACHE_DIR" >> $GITHUB_ENV

    # ===================== å®‰è£…å·¥å…·é“¾ =====================
    - name: ðŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          aria2 xz-utils ccache \
          build-essential git python3 \
          libncurses-dev zlib1g-dev

    # ===================== å‚æ•°é¢„å¤„ç† =====================
    - name: ðŸ” æž¶æž„å‚æ•°è½¬æ¢
      run: |
        # è½¬æ¢æž¶æž„æ ¼å¼ (x86/64 â†’ x86-64)
        SAFE_TARGET="${{ inputs.target }}" 
        SAFE_TARGET="${SAFE_TARGET//\//-}"
        
        # æå–ä¸»ç‰ˆæœ¬å· (23.05.5 â†’ 23.05)
        FW_MAJOR="${{ inputs.firmware_version }}"
        FW_MAJOR="${FW_MAJOR%.*}"
        
        echo "SAFE_TARGET=$SAFE_TARGET" >> $GITHUB_ENV
        echo "FW_MAJOR=$FW_MAJOR" >> $GITHUB_ENV

    # ===================== æ™ºèƒ½ä¸‹è½½SDK =====================
    - name: ðŸŒ å››é‡ä¿éšœä¸‹è½½
      run: |
        # é•œåƒæºä¼˜å…ˆçº§åˆ—è¡¨
        MIRRORS=(
          "https://downloads.openwrt.org"                  # å®˜æ–¹æº
          "https://op.supes.top/downloads"                # ç¤¾åŒºæŽ¨èæº
          "https://mirror.ghproxy.com/https://downloads.openwrt.org" # GitHubåŠ é€Ÿ
          "https://mirror.sjtu.edu.cn/openwrt"            # ä¸Šæµ·äº¤å¤§é•œåƒ
        )

        # æ–‡ä»¶ååŒ¹é…æ¨¡å¼
        PATTERNS=(
          "openwrt-sdk-${{ inputs.firmware_version }}-${SAFE_TARGET}_*"
          "openwrt-sdk-${FW_MAJOR}-*-${SAFE_TARGET}_*"
          "openwrt-sdk-*-${SAFE_TARGET}-*_Linux-x86_64.tar.xz"
        )

        # å¤šçº§ä¸‹è½½å°è¯•
        for mirror in "${MIRRORS[@]}"; do
          for pattern in "${PATTERNS[@]}"; do
            url="${mirror}/releases/${{ inputs.firmware_version }}/targets/${{ inputs.target }}/${pattern}"
            echo "ðŸ”— å°è¯•ä¸‹è½½: ${url}"
            
            if aria2c \
              --max-tries=3 \
              --retry-wait=30 \
              --timeout=600 \
              --allow-overwrite=true \
              -d "${CACHE_DIR}" \
              -o "sdk_temp.tar.xz" \
              "${url}"; then

              if xz -T0 -t "${CACHE_DIR}/sdk_temp.tar.xz"; then
                mv "${CACHE_DIR}/sdk_temp.tar.xz" "${CACHE_DIR}/sdk_${SAFE_TARGET}.tar.xz"
                echo "âœ… ä¸‹è½½æˆåŠŸ: ${url##*/}"
                exit 0
              else
                echo "âš ï¸ æ–‡ä»¶æ ¡éªŒå¤±è´¥ï¼Œç»§ç»­å°è¯•..."
                rm -f "${CACHE_DIR}/sdk_temp.tar.xz"
              fi
            fi
          done
        done

        # ç»ˆæžå¤‡ç”¨æ–¹æ¡ˆ
        echo "âš¡ å¯ç”¨ GitHub ä»“åº“å¤‡ä»½..."
        GH_BACKUP=(
          "https://raw.githubusercontent.com/openwrt-mirror/sdk-mirror/main/${{ inputs.firmware_version }}/${SAFE_TARGET}.tar.xz"
          "https://op.dllkit.xyz/sdk/${{ inputs.firmware_version }}/${SAFE_TARGET}.tar.xz"
        )

        for url in "${GH_BACKUP[@]}"; do
          if curl -L --retry 3 -o "${CACHE_DIR}/sdk_temp.tar.xz" "${url}"; then
            if xz -t "${CACHE_DIR}/sdk_temp.tar.xz"; then
              mv "${CACHE_DIR}/sdk_temp.tar.xz" "${CACHE_DIR}/sdk_${SAFE_TARGET}.tar.xz"
              echo "âœ… å¤‡ç”¨æºä¸‹è½½æˆåŠŸ"
              exit 0
            fi
          fi
        done

        echo "::error::âŒ æ‰€æœ‰ä¸‹è½½æ–¹å¼å‡å¤±è´¥ï¼è¯·æ£€æŸ¥ï¼š"
        echo "1. å®˜æ–¹ç›®å½•æ˜¯å¦å­˜åœ¨: https://downloads.openwrt.org/releases/${{ inputs.firmware_version }}/targets/${{ inputs.target }}/"
        echo "2. ç‰ˆæœ¬å·æ˜¯å¦æœ‰æ•ˆ (ç¤ºä¾‹: 23.05.5)"
        echo "3. æž¶æž„æ ¼å¼æ˜¯å¦æ­£ç¡® (ç¤ºä¾‹: x86/64)"
        exit 1

    # ===================== å‡†å¤‡ç¼–è¯‘çŽ¯å¢ƒ =====================
    - name: ðŸ’» è§£åŽ‹SDK
      run: |
        tar -xJf "${CACHE_DIR}/sdk_${SAFE_TARGET}.tar.xz" -C $BUILD_DIR --strip-components=1

    - name: ðŸ“‚ èŽ·å–æ’ä»¶æºç 
      run: |
        cd $BUILD_DIR
        git clone --filter=blob:none --branch master \
          https://github.com/vernesong/OpenClash package/${PLUGIN_NAME}
        
        # è‡ªåŠ¨ä¿®å¤Makefileç¼©è¿›
        find package/${PLUGIN_NAME} -name Makefile -exec sed -i 's/^    /\t/g' {} +

    # ===================== ç¼–è¯‘é…ç½® =====================
    - name: âš™ï¸ ç”Ÿæˆé…ç½®
      run: |
        cd $BUILD_DIR
        cat > .config <<EOF
        CONFIG_TARGET_${SAFE_TARGET//-/_}=y
        CONFIG_PACKAGE_${PLUGIN_NAME}=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        make defconfig

    # ===================== æ‰§è¡Œç¼–è¯‘ =====================
    - name: ðŸ­ å¼€å§‹ç¼–è¯‘
      run: |
        cd $BUILD_DIR
        make -j$(($(nproc) + 2)) \
          V=sc \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          package/${PLUGIN_NAME}/compile

    # ===================== å‘å¸ƒç»“æžœ =====================
    - name: ðŸš€ å‘å¸ƒRelease
      uses: softprops/action-gh-release@v2
      with:
        files: |
          $BUILD_DIR/bin/packages/**/*.ipk
        tag_name: openclash-${{ inputs.clash_core }}-$(date +%Y%m%d)
        name: OpenClash ${{ inputs.clash_core }} Build
        body: |
          ### ç¼–è¯‘ä¿¡æ¯
          | é¡¹ç›®          | å€¼                       |
          |--------------|--------------------------|
          | ç›®æ ‡æž¶æž„      | `${{ inputs.target }}`   |
          | OpenWrtç‰ˆæœ¬   | `${{ inputs.firmware_version }}` |
          | æ ¸å¿ƒç‰ˆæœ¬      | `${{ inputs.clash_core }}` |
          | ç¼–è¯‘æ—¶é—´      | `$(date -u +"%Y-%m-%dT%H:%M:%SZ")` |

          ### æ–‡ä»¶æ ¡éªŒ
          ```bash
          sha256sum *.ipk
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ===================== å¤±è´¥é€šçŸ¥ =====================
    - name: ðŸš¨ æž„å»ºå¤±è´¥é€šçŸ¥
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `â—ï¸ æž„å»ºå¤±è´¥!\n
              å¤±è´¥æ­¥éª¤: ${{ join(toJson(steps.*.outcome)) }}\n
              å®Œæ•´æ—¥å¿—: ${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          })
