name: OpenClash Stable Builder

on:
  push:
    paths:
      - '**.yml'
      - '**.yaml'
    branches: [ "main", "master" ]

  workflow_dispatch:
    inputs:
      target:
        description: 'Target Architecture (e.g. x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrt Version'
        required: true
        default: '23.05.5'
      clash_core:
        description: 'Mihomo Core Version (with v prefix)'
        required: true
        default: 'v1.18.0'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 50
    env:
      PLUGIN_NAME: luci-app-openclash

    steps:
    # ===================== åˆå§‹åŒ–é˜¶æ®µ =====================
    - name: ðŸ—ï¸ Initialize Workspace
      run: |
        # å®šä¹‰è·¯å¾„å˜é‡ï¼ˆæ­£ç¡®ä½¿ç”¨ä¸Šä¸‹æ–‡ï¼‰
        BUILD_DIR="${{ github.workspace }}/openwrt-build"
        CACHE_DIR="${{ runner.temp }}/sdk_cache"
        mkdir -p $BUILD_DIR $CACHE_DIR
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        echo "CACHE_DIR=$CACHE_DIR" >> $GITHUB_ENV

    # ===================== ä¾èµ–å®‰è£… =====================
    - name: ðŸ“¦ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          aria2 xz-utils ccache \
          build-essential git python3 \
          libncurses-dev zlib1g-dev

    # ===================== æž¶æž„è§£æž =====================
    - name: ðŸ” Parse Target Architecture
      run: |
        case "${{ inputs.target }}" in
          "x86/64")
            TARGET_CFG="x86_64"
            ARCH="amd64"
            ;;
          "arm/armv7")
            TARGET_CFG="armv7"
            ARCH="armv7"
            ;;
          "armvirt/64")
            TARGET_CFG="armvirt"
            ARCH="armv8"
            ;;
          *)
            TARGET_CFG="generic"
            ARCH="amd64"
            ;;
        esac
        echo "TARGET_CFG=$TARGET_CFG" >> $GITHUB_ENV
        echo "ARCH=$ARCH" >> $GITHUB_ENV

name: OpenClash Stable Builder

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æž¶æž„ (ç¤ºä¾‹: x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05.5'

env:
  CACHE_DIR: ${{ runner.temp }}/sdk_cache
  BUILD_DIR: ${{ github.workspace }}/openwrt-build

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    # ===================== åˆå§‹åŒ–é˜¶æ®µ =====================
    - name: ðŸ› ï¸ åˆå§‹åŒ–çŽ¯å¢ƒ
      run: |
        mkdir -p "$BUILD_DIR" "$CACHE_DIR"
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

    # ===================== ç‰ˆæœ¬è§£æž =====================
    - name: ðŸ” é¢„å¤„ç†å‚æ•°
      run: |
        # è½¬æ¢æž¶æž„æ ¼å¼ x86/64 â†’ x86-64
        formatted_target="${INPUT_TARGET//\//-}"
        # æå–ä¸»ç‰ˆæœ¬å· 23.05.5 â†’ 23.05
        firmware_major="${INPUT_FIRMWARE_VERSION%.*}"
        
        echo "FORMATTED_TARGET=$formatted_target" >> $GITHUB_ENV
        echo "FIRMWARE_MAJOR=$firmware_major" >> $GITHUB_ENV

    # ===================== ä¸‹è½½é˜¶æ®µ =====================
    - name: ðŸŒ æ™ºèƒ½ä¸‹è½½SDK
      env:
        MIRRORS: >
          https://downloads.openwrt.org,
          https://mirror.sjtu.edu.cn/openwrt,
          https://mirrors.tuna.tsinghua.edu.cn/openwrt
      run: |
        # å®šä¹‰æ–‡ä»¶ååŒ¹é…æ¨¡å¼
        patterns=(
          "openwrt-sdk-${INPUT_FIRMWARE_VERSION}-${FORMATTED_TARGET}_*"
          "openwrt-sdk-${FIRMWARE_MAJOR}-*-${FORMATTED_TARGET}_*"
        )

        # å¤šæºå¤šæ¨¡å¼å°è¯•
        for mirror in ${MIRRORS//,/ }; do
          for pattern in "${patterns[@]}"; do
            full_url="${mirror}/releases/${INPUT_FIRMWARE_VERSION}/targets/${INPUT_TARGET}/${pattern}"
            echo "ðŸ”— å°è¯•ä¸‹è½½: $full_url"
            
            if aria2c -x8 -s8 --file-allocation=none -o "$CACHE_DIR/temp.tar.xz" "$full_url"; then
              if xz -t "$CACHE_DIR/temp.tar.xz"; then
                mv "$CACHE_DIR/temp.tar.xz" "$CACHE_DIR/sdk.tar.xz"
                echo "âœ… éªŒè¯é€šè¿‡: ${full_url##*/}"
                exit 0
              fi
            fi
          done
        done

        echo "::error::æ‰€æœ‰ä¸‹è½½æºå‡å¤±è´¥"
        exit 1

    # ===================== åŽç»­æ­¥éª¤ =====================
    # ... [ä¿ç•™åŽŸæœ‰çš„ç¼–è¯‘å’Œå‘å¸ƒæ­¥éª¤] ...

    # ===================== æºç å‡†å¤‡ =====================
    - name: ðŸ’¾ Prepare Source Code
      run: |
        # è§£åŽ‹SDK
        tar -xJf "${{ env.CACHE_DIR }}/sdk.tar.xz" -C ${{ env.BUILD_DIR }} --strip-components=1

        # å…‹éš†æ’ä»¶æºç 
        cd ${{ env.BUILD_DIR }}
        git clone --depth 1 --branch master \
          https://github.com/vernesong/OpenClash package/${{ env.PLUGIN_NAME }}

        # ä¿®å¤Makefile
        find package/${{ env.PLUGIN_NAME }} -name Makefile -exec sed -i 's/^    /\t/g' {} +

    # ===================== ç¼–è¯‘é…ç½® =====================
    - name: âš™ï¸ Configure Build
      run: |
        cd ${{ env.BUILD_DIR }}
        cat > .config <<EOF
        CONFIG_TARGET_${TARGET_CFG}=y
        CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        make defconfig

    # ===================== æ‰§è¡Œç¼–è¯‘ =====================
    - name: ðŸ› ï¸ Compile Package
      run: |
        cd ${{ env.BUILD_DIR }}
        make -j$(($(nproc) + 2)) \
          V=sc \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          package/${{ env.PLUGIN_NAME }}/compile

    # ===================== å‘å¸ƒäº§ç‰© =====================
    - name: ðŸš€ Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.BUILD_DIR }}/bin/packages/**/*.ipk
        tag_name: openclash-${{ inputs.clash_core }}-$(date +%Y%m%d)
        name: OpenClash ${{ inputs.clash_core }} Build
        body: |
          ### Build Info
          - â€‹**Target**: ${{ inputs.target }}
          - â€‹**OpenWrt**: ${{ inputs.firmware_version }}
          - â€‹**Core**: ${{ inputs.clash_core }}
          - â€‹**Timestamp**: `$(date -u +'%Y-%m-%dT%H:%M:%SZ')`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ===================== é”™è¯¯å¤„ç† =====================
    - name: ðŸš¨ Error Notification
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `â— Build Failed!\n
              Job: ${context.job}\n
              Error: ${{ join(toJson(steps.*.conclusion)) }}\n
              Logs: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          })
