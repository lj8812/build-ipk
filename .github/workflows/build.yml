name: OpenClash æ’ä»¶ç¼–è¯‘ (å« Mihomo å†…æ ¸)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æ¶æ„ (å¦‚ x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrt ç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core_version:
        description: 'Mihomo å†…æ ¸ç‰ˆæœ¬ (å¸¦ v å‰ç¼€)'
        required: true
        default: 'v1.18.0'
      plugin_branch:
        description: 'æ’ä»¶æºç åˆ†æ”¯'
        required: true
        default: 'master'

env:
  PLUGIN_NAME: luci-app-openclash
  BUILD_DIR: ${{ github.workspace }}/openwrt-build

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
    - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        mkdir -p $BUILD_DIR
        echo "ğŸ”§ å·¥ä½œç›®å½•: $BUILD_DIR"

    - name: ğŸ“¥ å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 \
          python3-distutils python3-setuptools unzip wget rsync subversion \
          swig time xsltproc zlib1g-dev tree jq p7zip-full

    - name: ğŸ é…ç½® Python ç¯å¢ƒ
      run: |
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        python -m pip install --upgrade pip
        pip install requests

    - name: ğŸŒ è§£æç›®æ ‡æ¶æ„
      id: parse_target
      run: |
        case "${{ github.event.inputs.target }}" in
          "x86/64")    ARCH="amd64"; TARGET_CFG="x86_64" ;;
          "armvirt/64") ARCH="armv8"; TARGET_CFG="armvirt" ;;
          "arm64")     ARCH="armv8"; TARGET_CFG="arm64" ;;
          "arm/armv7") ARCH="armv7"; TARGET_CFG="armv7" ;;
          *)           ARCH="amd64"; TARGET_CFG="generic" ;;
        esac

        echo "ARCH=$ARCH" >> $GITHUB_ENV
        echo "TARGET_CFG=$TARGET_CFG" >> $GITHUB_ENV
        echo "TARGET_DASH=$(echo ${{ github.event.inputs.target }} | tr '/' '-')" >> $GITHUB_ENV

    - name: ğŸ” éªŒè¯å†…æ ¸ç‰ˆæœ¬
      run: |
        VERSION_URL="https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/${{ github.event.inputs.clash_core_version }}"
        if ! curl -sH "Accept: application/vnd.github.v3+json" "$VERSION_URL" | jq -e .id > /dev/null; then
          echo "::error::âŒ æ— æ•ˆçš„ Mihomo ç‰ˆæœ¬: ${{ github.event.inputs.clash_core_version }}"
          echo "å¯ç”¨ç‰ˆæœ¬åˆ—è¡¨: https://github.com/MetaCubeX/mihomo/releases"
          exit 1
        fi

    - name: ğŸ“¦ ä¸‹è½½ OpenWrt SDK
      run: |
        SDK_BASE="https://downloads.openwrt.org/releases/${{ github.event.inputs.firmware_version }}/targets/${{ github.event.inputs.target }}"
        SDK_PATTERN="openwrt-sdk-.*-${{ env.TARGET_DASH }}.*Linux-x86_64.tar.xz"
        
        echo "ğŸ” æŸ¥æ‰¾ SDK æ–‡ä»¶..."
        SDK_FILE=$(curl -sL "$SDK_BASE/" | grep -oP "$SDK_PATTERN" | head -1)
        [ -z "$SDK_FILE" ] && { echo "::error::æœªæ‰¾åˆ° SDK æ–‡ä»¶"; exit 1; }

        echo "â¬‡ï¸ ä¸‹è½½: $SDK_BASE/$SDK_FILE"
        curl --retry 3 -o sdk.tar.xz "$SDK_BASE/$SDK_FILE"
        
        echo "ğŸ”’ éªŒè¯æ–‡ä»¶å®Œæ•´æ€§..."
        xz -t sdk.tar.xz || { echo "::error::æ–‡ä»¶æŸå"; exit 1; }
        
        echo "ğŸ“‚ è§£å‹ SDK..."
        tar -xJf sdk.tar.xz -C $BUILD_DIR --strip-components=1
        rm sdk.tar.xz

    - name: ğŸ’¾ å‡†å¤‡æ’ä»¶æºç 
      run: |
        cd $BUILD_DIR
        git clone --depth 1 --branch ${{ github.event.inputs.plugin_branch }} \
          https://github.com/vernesong/OpenClash package/$PLUGIN_NAME
        
        cd package/$PLUGIN_NAME/$PLUGIN_NAME
        sed -i 's/^    /\t/g' Makefile
        PLUGIN_VERSION=$(grep 'PKG_VERSION:' Makefile | cut -d= -f2 | tr -d ' ')
        echo "PLUGIN_VERSION=$PLUGIN_VERSION" >> $GITHUB_ENV

    - name: âš™ï¸ é¢„ç½®å†…æ ¸æ–‡ä»¶
      run: |
        CORE_DIR="$BUILD_DIR/package/$PLUGIN_NAME/$PLUGIN_NAME/files/etc/openclash/core"
        mkdir -p $CORE_DIR
        
        echo "â¬‡ï¸ ä¸‹è½½ Mihomo ${{ github.event.inputs.clash_core_version }} å†…æ ¸..."
        CORE_URL="https://github.com/MetaCubeX/mihomo/releases/download/${{ github.event.inputs.clash_core_version }}/mihomo-linux-$ARCH.gz"
        curl -L $CORE_URL | gunzip > $CORE_DIR/clash
        chmod 755 $CORE_DIR/clash

    - name: ğŸ”§ é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd $BUILD_DIR
        echo "CONFIG_TARGET_${TARGET_CFG}=y" > .config
        echo "CONFIG_PACKAGE_$PLUGIN_NAME=m" >> .config
        make defconfig

    - name: ğŸ—ï¸ ç¼–è¯‘æ’ä»¶
      run: |
        cd $BUILD_DIR
        make -j$(($(nproc) + 1)) \
          V=s \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          package/$PLUGIN_NAME/compile

    - name: ğŸ“¦ æ•´ç†è¾“å‡ºæ–‡ä»¶
      run: |
        OUTPUT_DIR="${{ github.workspace }}/output"
        mkdir -p $OUTPUT_DIR
        
        find $BUILD_DIR/bin -name "*.ipk" -exec cp {} $OUTPUT_DIR \;
        
        for ipk in $OUTPUT_DIR/*.ipk; do
          new_name="${{ env.TARGET_DASH }}_${{ github.event.inputs.firmware_version }}_${ipk##*/}"
          mv "$ipk" "$OUTPUT_DIR/$new_name"
        done

        echo "ğŸ“„ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯..."
        jq -n \
          --arg target "${{ github.event.inputs.target }}" \
          --arg fw_ver "${{ github.event.inputs.firmware_version }}" \
          --arg core_ver "${{ github.event.inputs.clash_core_version }}" \
          --arg plugin_ver "${{ env.PLUGIN_VERSION }}" \
          '{target: $target, firmware: $fw_ver, core: $core_ver, plugin: $plugin_ver}' \
          > $OUTPUT_DIR/build-info.json

    - name: ğŸš€ å‘å¸ƒ Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          output/*
        tag_name: openclash-${{ github.event.inputs.clash_core_version }}-${{ env.PLUGIN_VERSION }}
        name: OpenClash ${{ github.event.inputs.clash_core_version }}
        body: |
          ### ç¼–è¯‘ä¿¡æ¯
          - â€‹**æ¶æ„**: `${{ github.event.inputs.target }}`
          - â€‹**OpenWrt**: `${{ github.event.inputs.firmware_version }}`
          - â€‹**Mihomo**: `${{ github.event.inputs.clash_core_version }}`
          - â€‹**æ’ä»¶ç‰ˆæœ¬**: `${{ env.PLUGIN_VERSION }}`
          - â€‹**ç¼–è¯‘æ—¶é—´**: `$(date -u +"%Y-%m-%d %H:%M:%S UTC")`

          ### æ–‡ä»¶æ¸…å•
          ```json
          $(cat output/build-info.json)
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
