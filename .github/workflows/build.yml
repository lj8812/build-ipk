name: OpenClash AutoBuild (Stable)

on:
  push:
    paths:
      - '**.yml'
      - '**.yaml'
    branches: [ "main", "master" ]

  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æž¶æž„ (ç¤ºä¾‹: x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core:
        description: 'Mihomoæ ¸å¿ƒç‰ˆæœ¬ (å¸¦vå‰ç¼€)'
        required: true
        default: 'v1.18.0'

env:
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    steps:
    # ===================== åˆå§‹åŒ–é˜¶æ®µ =====================
    - name: ðŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº
      run: |
        # æ­£ç¡®ä½¿ç”¨ runner ä¸Šä¸‹æ–‡
        BUILD_DIR="${{ github.workspace }}/openwrt-build"
        CACHE_DIR="${{ runner.temp }}/sdk_cache"
        mkdir -p $BUILD_DIR $CACHE_DIR
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        echo "CACHE_DIR=$CACHE_DIR" >> $GITHUB_ENV

    # ===================== ä¾èµ–å®‰è£… =====================
    - name: ðŸ“¥ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          aria2 xz-utils ccache \
          build-essential git python3

    # ===================== SDKä¸‹è½½ =====================
    - name: ðŸŒ ä¸‹è½½OpenWrt SDK
      run: |
        # ä½¿ç”¨æ­¥éª¤å†…å˜é‡
        SDK_PATH="releases/${{ inputs.firmware_version }}/targets/${{ inputs.target }}"
        SDK_URL="https://downloads.openwrt.org/$SDK_PATH"
        
        echo "ðŸ” æ­£åœ¨æŸ¥æ‰¾ SDK æ–‡ä»¶..."
        SDK_FILE=$(curl -sL "$SDK_URL" | grep -oE 'openwrt-sdk-.*?Linux-x86_64\.tar\.xz' | head -1)
        
        # å¤šé•œåƒæºä¸‹è½½
        MIRRORS=(
          "$SDK_URL/$SDK_FILE"
          "https://mirror.sjtu.edu.cn/openwrt/$SDK_PATH/$SDK_FILE"
        )

        for url in "${MIRRORS[@]}"; do
          echo "â¬‡ï¸ å°è¯•ä¸‹è½½: $url"
          if curl --retry 3 -L -o "${{ env.CACHE_DIR }}/sdk.tar.xz" "$url"; then
            if xz -t "${{ env.CACHE_DIR }}/sdk.tar.xz"; then
              echo "âœ… ä¸‹è½½éªŒè¯æˆåŠŸ"
              exit 0
            fi
          fi
        done
        
        echo "::error::æ‰€æœ‰é•œåƒæºä¸‹è½½å¤±è´¥"
        exit 1

    # ===================== æºç å‡†å¤‡ =====================
    - name: ðŸ’¾ èŽ·å–æ’ä»¶æºç 
      run: |
        cd ${{ env.BUILD_DIR }}
        git clone --depth 1 --branch master \
          https://github.com/vernesong/OpenClash package/${{ env.PLUGIN_NAME }}
        
        # Makefileæ ¼å¼ä¿®å¤
        find package/${{ env.PLUGIN_NAME }} -name Makefile -exec sed -i 's/^    /\t/g' {} +

    # ===================== ç¼–è¯‘é…ç½® =====================
    - name: âš™ï¸ é…ç½®ç¼–è¯‘çŽ¯å¢ƒ
      run: |
        cd ${{ env.BUILD_DIR }}
        cat > .config <<EOF
        CONFIG_TARGET_${{ inputs.target##*/ }}=y
        CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        make defconfig

    # ===================== ç¼–è¯‘æ‰§è¡Œ =====================
    - name: ðŸ­ æ‰§è¡Œç¼–è¯‘
      run: |
        cd ${{ env.BUILD_DIR }}
        make -j$(($(nproc) + 2)) V=s \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          package/${{ env.PLUGIN_NAME }}/compile

    # ===================== äº§ç‰©å‘å¸ƒ =====================
    - name: ðŸš€ å‘å¸ƒç‰ˆæœ¬
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.BUILD_DIR }}/bin/packages/**/*.ipk
        tag_name: openclash-${{ inputs.clash_core }}-$(date +%Y%m%d)
        name: OpenClash Build ${{ inputs.clash_core }}
        body: |
          ### æž„å»ºä¿¡æ¯
          - â€‹**æž¶æž„**: ${{ inputs.target }}
          - â€‹**å›ºä»¶ç‰ˆæœ¬**: ${{ inputs.firmware_version }}
          - â€‹**æ ¸å¿ƒç‰ˆæœ¬**: ${{ inputs.clash_core }}
          - â€‹**ç¼–è¯‘æ—¶é—´**: `$(date -u +'%Y-%m-%dT%H:%M:%SZ')`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
