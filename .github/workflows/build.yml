name: ç¼–è¯‘ OpenClash æ’ä»¶

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æ¶æ„ (ä¾‹å¦‚ x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrt ç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core_version:
        description: 'Clash å†…æ ¸ç‰ˆæœ¬ (å¸¦ v å‰ç¼€)'
        required: true
        default: 'v2024.05.01'

env:
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 60

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ä¾èµ–å·¥å…·é“¾
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 \
          python3-distutils python3-setuptools unzip wget rsync subversion \
          swig time xsltproc zlib1g-dev tree jq

    - name: è®¾ç½® Python ç¯å¢ƒ
      run: |
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        python --version

    - name: è§£æç›®æ ‡å‚æ•°
      id: parse_target
      run: |
        # è½¬æ¢æ¶æ„æ ¼å¼ x86/64 â†’ x86-64
        TARGET_SLUG=$(echo "${{ github.event.inputs.target }}" | sed 's/\//-/g')
        echo "TARGET_SLUG=$TARGET_SLUG" >> $GITHUB_OUTPUT
        
        # æå–æ¶æ„åç¼€ (64/armv8)
        ARCH_TYPE=$(echo "${{ github.event.inputs.target }}" | cut -d'/' -f2)
        echo "ARCH_TYPE=$ARCH_TYPE" >> $GITHUB_OUTPUT

    - name: ä¸‹è½½ OpenWrt SDK
      run: |
        SDK_BASE="https://downloads.openwrt.org/releases/${{ github.event.inputs.firmware_version }}/targets/${{ github.event.inputs.target }}/"
        echo "ğŸ› ï¸ SDK ä¸‹è½½ç›®å½•: $SDK_BASE"

        # åŠ¨æ€ç”ŸæˆåŒ¹é…æ¨¡å¼
        case "${{ github.event.inputs.target }}" in
          "x86/64")
            PATTERN='openwrt-sdk-\d+\.\d+\.\d+-x86-64_gcc-\d+\.\d+\.\d+_musl\.Linux-x86_64\.tar\.xz'
            ;;
          "armvirt/64")
            PATTERN='openwrt-sdk-\d+\.\d+\.\d+-armvirt-64-gcc-\d+\.\d+\.\d+_musl\.Linux-x86_64\.tar\.xz'
            ;;
          *)
            echo "::error::ä¸æ”¯æŒçš„æ¶æ„ç±»å‹"
            exit 1
            ;;
        esac

        # æå– SDK æ–‡ä»¶å
        SDK_FILE=$(curl -s "$SDK_BASE" | grep -oP "$PATTERN" | head -n1)
        echo "ğŸ” åŒ¹é…åˆ°çš„ SDK æ–‡ä»¶: $SDK_FILE"

        if [ -z "$SDK_FILE" ]; then
          echo "::error::âŒ æœªæ‰¾åˆ°ç¬¦åˆçš„ SDK æ–‡ä»¶"
          exit 1
        fi

        # éªŒè¯ä¸‹è½½é“¾æ¥æœ‰æ•ˆæ€§
        FULL_URL="${SDK_BASE}${SDK_FILE}"
        echo "ğŸ”— å®Œæ•´ä¸‹è½½åœ°å€: $FULL_URL"
        if ! curl --output /dev/null --silent --head --fail "$FULL_URL"; then
          echo "::error::âŒ ä¸‹è½½é“¾æ¥æ— æ•ˆ"
          exit 1
        fi

        # ä¸‹è½½å¹¶è§£å‹ SDK
        echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½ SDK..."
        wget --progress=dot:giga "$FULL_URL" -O openwrt-sdk.tar.xz
        mkdir -p openwrt
        tar -xJf openwrt-sdk.tar.xz -C openwrt --strip-components 1
        echo "âœ… SDK è§£å‹å®Œæˆ"

    - name: å‡†å¤‡æ’ä»¶æºç 
      working-directory: openwrt/package
      run: |
        echo "ğŸ“¦ å…‹éš† OpenClash ä»“åº“..."
        git clone --depth 1 https://github.com/lj8812/OpenClash ${{ env.PLUGIN_NAME }}
        
        cd ${{ env.PLUGIN_NAME }}/luci-app-openclash
        echo "ğŸ”§ ä¿®å¤ Makefile æ ¼å¼..."
        sed -i 's/^    /\t/g' Makefile    # æ›¿æ¢ç©ºæ ¼ä¸º Tab
        sed -i 's/\r$//' Makefile         # ç§»é™¤ Windows æ¢è¡Œç¬¦

        # é¢„ç½® Clash å†…æ ¸
        echo "â¬‡ï¸ ä¸‹è½½ Clash å†…æ ¸..."
        mkdir -p files/etc/openclash/core
        case "${{ steps.parse_target.outputs.ARCH_TYPE }}" in
          "64")
            CORE_URL="https://github.com/Dreamacro/clash/releases/download/${{ github.event.inputs.clash_core_version }}/clash-linux-amd64-${{ github.event.inputs.clash_core_version }}.gz"
            ;;
          "armv8")
            CORE_URL="https://github.com/Dreamacro/clash/releases/download/${{ github.event.inputs.clash_core_version }}/clash-linux-arm64-${{ github.event.inputs.clash_core_version }}.gz"
            ;;
          *)
            echo "::error::âŒ ä¸æ”¯æŒçš„æ¶æ„ç±»å‹: ${{ steps.parse_target.outputs.ARCH_TYPE }}"
            exit 1
            ;;
        esac

        echo "ğŸ”— å†…æ ¸ä¸‹è½½åœ°å€: $CORE_URL"
        if ! wget -q --show-progress "$CORE_URL" -O clash.gz; then
          echo "::error::âŒ å†…æ ¸ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        gunzip clash.gz
        mv clash files/etc/openclash/core/
        chmod +x files/etc/openclash/core/clash
        echo "âœ… å†…æ ¸é¢„ç½®å®Œæˆ"

        # ç¦ç”¨è‡ªåŠ¨æ›´æ–°
        echo "âš™ï¸ ç¦ç”¨è‡ªåŠ¨æ›´æ–°..."
        sed -i 's/option auto_update .*/option auto_update "0"/' root/etc/config/openclash
        sed -i 's/option release_branch .*/option release_branch "disabled"/' root/etc/config/openclash

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      working-directory: openwrt
      run: |
        echo "âš™ï¸ ç”Ÿæˆç¼–è¯‘é…ç½®..."
        TARGET_CONFIG="CONFIG_TARGET_$(echo '${{ github.event.inputs.target }}' | tr / _)"
        echo "$TARGET_CONFIG=y" > .config
        echo "CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-tproxy=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        make defconfig

    - name: æ‰§è¡Œç¼–è¯‘
      working-directory: openwrt
      run: |
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
        export PATH=$PATH:$GITHUB_WORKSPACE/openwrt/staging_dir/host/bin
        make -j$(nproc) package/${{ env.PLUGIN_NAME }}/compile V=s

    - name: ç”Ÿæˆæ—¶é—´æˆ³
      id: get_timestamp
      run: echo "DATE=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: æ‰“åŒ…è¾“å‡ºæ–‡ä»¶
      run: |
        echo "ğŸ“¦ æ‰“åŒ…åˆ¶å“..."
        mkdir -p artifacts
        find openwrt/bin/packages -name "${{ env.PLUGIN_NAME }}*.ipk" -exec cp -v {} artifacts/ \;
        
        cd artifacts
        for f in *.ipk; do
          NEW_NAME="openclash_$(echo '${{ github.event.inputs.target }}' | tr / -)_${{ github.event.inputs.firmware_version }}_${{ github.event.inputs.clash_core_version }}.ipk"
          echo "ğŸ”„ é‡å‘½å: $f â†’ $NEW_NAME"
          mv "$f" "$NEW_NAME"
        done
        echo "âœ… æœ€ç»ˆç”Ÿæˆæ–‡ä»¶:"
        ls -lh

    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openclash-packages
        path: artifacts/*.ipk
        retention-days: 7

    - name: åˆ›å»º GitHub Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/*.ipk
        tag_name: openclash-${{ github.event.inputs.target }}-${{ github.event.inputs.firmware_version }}-${{ github.event.inputs.clash_core_version }}
        name: OpenClash ${{ github.event.inputs.clash_core_version }} (${{ github.event.inputs.target }})
        body: |
          ### ğŸ“¦ ç¼–è¯‘ä¿¡æ¯
          - â€‹**ç›®æ ‡æ¶æ„**: `${{ github.event.inputs.target }}`
          - â€‹**OpenWrt ç‰ˆæœ¬**: `${{ github.event.inputs.firmware_version }}`
          - â€‹**Clash å†…æ ¸ç‰ˆæœ¬**: `${{ github.event.inputs.clash_core_version }}`
          - â€‹**ç¼–è¯‘æ—¶é—´**: `${{ steps.get_timestamp.outputs.DATE }}`

          ### âš™ï¸ åŠŸèƒ½ç‰¹æ€§
          âœ… é¢„ç¼–è¯‘å†…æ ¸é›†æˆ  
          âœ… è‡ªåŠ¨æ›´æ–°ç¦ç”¨  
          âœ… å¤šæ¶æ„æ”¯æŒ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
