name: 编译 OpenClash 插件

on:
  workflow_dispatch:
    inputs:
      target:
        description: '目标架构 (x86/64 或 armvirt/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrt 版本 (如 23.05.5)'
        required: true
        default: '23.05.5'
      clash_core_version:
        description: 'Clash.Meta 内核版本 (带 v 前缀)'
        required: true
        default: 'v1.18.0'

env:
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 90

    steps:
    - name: 检出仓库
      uses: actions/checkout@v4

    - name: 安装依赖工具链
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 \
          python3-distutils python3-setuptools unzip wget rsync subversion \
          swig time xsltproc zlib1g-dev tree jq

    - name: 设置 Python 环境
      run: |
        sudo rm -f /usr/bin/python
        sudo ln -s /usr/bin/python3 /usr/bin/python
        python --version

    - name: 解析目标参数
      id: parse_target
      run: |
        TARGET_SLUG=$(echo "${{ github.event.inputs.target }}" | sed 's/\//-/g')
        echo "TARGET_SLUG=$TARGET_SLUG" >> $GITHUB_OUTPUT
        
        case "${{ github.event.inputs.target }}" in
          "x86/64")    ARCH="amd64"  ;;
          "armvirt/64") ARCH="arm64" ;;
          *) echo "::error::不支持的架构"; exit 1 ;;
        esac
        echo "ARCH=$ARCH" >> $GITHUB_OUTPUT

    - name: 下载 OpenWrt SDK
      run: |
        SDK_BASE="https://downloads.openwrt.org/releases/${{ github.event.inputs.firmware_version }}/targets/${{ github.event.inputs.target }}/"
        echo "🛠️ SDK 基地址: $SDK_BASE"

        # 获取页面内容并解析
        SDK_PAGE=$(curl -sL "$SDK_BASE")
        SDK_FILE=$(echo "$SDK_PAGE" | grep -oE 'href="openwrt-sdk-[^"]+\.tar\.xz"' | sed 's/href="//;s/"//' | sort -Vr | head -n1)

        if [[ -z "$SDK_FILE" ]]; then
          echo "::error::❌ SDK 文件未找到，请检查以下可能原因："
          echo "1. 版本号是否正确？当前：${{ github.event.inputs.firmware_version }}"
          echo "2. 目标架构是否存在？当前：${{ github.event.inputs.target }}"
          echo "3. 页面内容验证："
          echo "$SDK_PAGE" | head -n 20
          exit 1
        fi
        echo "✅ 确认 SDK 文件: $SDK_FILE"

        # URL 编码处理
        ENCODED_FILE=$(echo "$SDK_FILE" | sed 's/ /%20/g')
        FULL_URL="${SDK_BASE}${ENCODED_FILE}"
        echo "🔗 最终下载地址: $FULL_URL"

        # 增强下载重试逻辑
        MAX_RETRY=5
        for ((i=1; i<=MAX_RETRY; i++)); do
          if wget --tries=3 --progress=bar:force:noscroll "$FULL_URL" -O sdk.tar.xz; then
            echo "✅ 下载成功 (尝试次数: $i)"
            break
          elif [ $i -eq $MAX_RETRY ]; then
            echo "::error::❌ 最终下载失败！请手动验证："
            echo "wget -q --spider '$FULL_URL'"
            exit 1
          else
            echo "⚠️ 下载失败，等待重试 (${i}/${MAX_RETRY})..."
            sleep $((i * 10))
          fi
        done

        # 压缩包完整性验证
        if ! tar -tvJf sdk.tar.xz > /dev/null 2>&1; then
          echo "::error::❌ 压缩包校验失败！可能原因："
          echo "1. 文件下载不完整"
          echo "2. 服务器文件损坏"
          echo "3. 网络传输错误"
          exit 1
        fi

        mkdir -p openwrt
        tar -xJf sdk.tar.xz -C openwrt --strip-components 1
        rm sdk.tar.xz

    - name: 准备插件源码
      working-directory: openwrt/package
      run: |
        git clone --depth 1 --branch master https://github.com/vernesong/OpenClash.git ${{ env.PLUGIN_NAME }}
        
        cd ${{ env.PLUGIN_NAME }}/luci-app-openclash
        sed -i -e 's/^    /\t/g' -e 's/\r$//' Makefile

        # 内核下载优化
        CORE_DIR="files/etc/openclash/core"
        mkdir -p $CORE_DIR
        ARCH=${{ steps.parse_target.outputs.ARCH }}

        CORE_URLS=(
          "https://github.com/MetaCubeX/Clash.Meta/releases/download/${{ github.event.inputs.clash_core_version }}/clash.meta-linux-${ARCH}.gz"
          "https://github.com/MetaCubeX/Clash.Meta/releases/download/${{ github.event.inputs.clash_core_version }}/clash.meta-${ARCH}.gz"
          "https://github.com/MetaCubeX/Clash.Meta/releases/download/${{ github.event.inputs.clash_core_version }}/clash.meta-${ARCH}-${{ github.event.inputs.clash_core_version }}.gz"
        )

        for url in "${CORE_URLS[@]}"; do
          echo "🔍 尝试下载: $url"
          if curl --output /dev/null --silent --head --fail "$url"; then
            echo "✅ 有效链接: $url"
            wget -q --show-progress "$url" -O clash.gz
            if gunzip -t clash.gz; then
              gunzip clash.gz
              mv clash $CORE_DIR/
              chmod 755 $CORE_DIR/clash
              echo "🎉 内核下载成功"
              break
            else
              echo "⚠️ 压缩包损坏，尝试下一个链接..."
              rm -f clash.gz
            fi
          fi
        done

        # 禁用自动更新
        sed -i -e 's/option auto_update .*/option auto_update "0"/' \
               -e 's/option release_branch .*/option release_branch "disabled"/' root/etc/config/openclash

    - name: 配置编译环境
      working-directory: openwrt
      run: |
        cat << EOF > .config
        CONFIG_TARGET_$(echo ${{ github.event.inputs.target }} | tr '/a-z' '_A-Z')=y
        CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m
        CONFIG_PACKAGE_dnsmasq-full=y
        CONFIG_PACKAGE_coreutils-nohup=y
        CONFIG_PACKAGE_iptables-mod-tproxy=y
        CONFIG_PACKAGE_luci-compat=y
        EOF
        
        make defconfig
        echo "ℹ️ 编译配置预览："
        grep -rn "CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}" .config

    - name: 执行编译
      working-directory: openwrt
      run: |
        export PATH="$PATH:$GITHUB_WORKSPACE/openwrt/staging_dir/host/bin"
        make -j$(($(nproc) + 1)) package/${{ env.PLUGIN_NAME }}/compile V=sc 2>&1 | tee build.log
        
        if ! grep -q "package/${{ env.PLUGIN_NAME }}/compile: Finished" build.log; then
          echo "::error::❌ 编译失败！错误摘要："
          grep -iE 'error:|warning:|失败' build.log | head -n 50
          exit 1
        fi

    - name: 打包输出
      run: |
        ARTIFACT_NAME="openclash_${{ steps.parse_target.outputs.TARGET_SLUG }}_${{ github.event.inputs.firmware_version }}_${{ github.event.inputs.clash_core_version }}"
        mkdir -p $ARTIFACT_NAME
        
        find openwrt/bin/packages -name "luci-app-openclash*.ipk" -exec cp -v {} $ARTIFACT_NAME/ \;
        echo "📦 生成文件列表："
        ls -lh $ARTIFACT_NAME

    - name: 上传制品
      uses: actions/upload-artifact@v4
      with:
        name: openclash-packages
        path: |
          openclash_*
          !*.tmp
        retention-days: 7

    - name: 创建 Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: openclash-${{ steps.parse_target.outputs.TARGET_SLUG }}-${{ github.event.inputs.firmware_version }}
        name: OpenClash ${{ github.event.inputs.clash_core_version }} (${{ github.event.inputs.target }})
        body: |
          ### 🚀 编译信息
          - ​**架构**: `${{ github.event.inputs.target }}`
          - ​**OpenWrt 版本**: ${{ github.event.inputs.firmware_version }}
          - ​**Clash.Meta 版本**: ${{ github.event.inputs.clash_core_version }}
          - ​**编译时间**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          ### 📥 安装说明
          ```bash
          opkg install luci-app-openclash_*.ipk
          /etc/init.d/openclash start
          ```

          ### ⚠️ 注意事项
          1. 已预置最新 Clash.Meta 内核
          2. 默认禁用自动更新
          3. 需要 200MB 以上存储空间
        files: openclash_*/*.ipk
