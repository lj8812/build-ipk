name: ç¼–è¯‘ OpenClash æ’ä»¶

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æ¶æ„ (x86/64 æˆ– armvirt/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrt ç‰ˆæœ¬ (å¦‚ 23.05.5)'
        required: true
        default: '23.05.5'
      clash_core_version:
        description: 'mihomo å†…æ ¸ç‰ˆæœ¬ (å¸¦ v å‰ç¼€)'
        required: true
        default: 'v1.18.0'

env:
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 90

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ä¾èµ–å·¥å…·é“¾
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 \
          python3-distutils python3-setuptools unzip wget rsync subversion \
          swig time xsltproc zlib1g-dev tree jq

    - name: è®¾ç½® Python ç¯å¢ƒ
      run: |
        sudo rm -f /usr/bin/python
        sudo ln -s /usr/bin/python3 /usr/bin/python
        python --version

    - name: è§£æç›®æ ‡å‚æ•°
      id: parse_target
      run: |
        TARGET_DASH=$(echo "${{ github.event.inputs.target }}" | sed 's/\//-/g')
        echo "TARGET_DASH=$TARGET_DASH" >> $GITHUB_OUTPUT
        
        case "${{ github.event.inputs.target }}" in
          "x86/64")    ARCH="amd64"  ;;
          "armvirt/64") ARCH="arm64" ;;
          *) echo "::error::ä¸æ”¯æŒçš„æ¶æ„"; exit 1 ;;
        esac
        echo "ARCH=$ARCH" >> $GITHUB_OUTPUT

    - name: ä¸‹è½½ OpenWrt SDK
      run: |
        SDK_BASE_URL="https://downloads.openwrt.org/releases/${{ github.event.inputs.firmware_version }}/targets/${{ github.event.inputs.target }}/"
        echo "ğŸ› ï¸ SDK åŸºåœ°å€: $SDK_BASE_URL"

        # è·å– SDK æ–‡ä»¶å
        SDK_FILE=$(curl -s "$SDK_BASE_URL" | grep -oP "openwrt-sdk-.*?-${{ steps.parse_target.outputs.TARGET_DASH }}_gcc-.*?Linux-x86_64.tar.xz" | head -n1)
        if [ -z "$SDK_FILE" ]; then
          echo "::error::âŒ SDK æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥ï¼š"
          echo "1. ç‰ˆæœ¬æ˜¯å¦å­˜åœ¨: ${{ github.event.inputs.firmware_version }}"
          echo "2. æ¶æ„æ˜¯å¦æ­£ç¡®: ${{ github.event.inputs.target }}"
          exit 1
        fi

        # åˆ›å»ºç›®æ ‡ç›®å½•
        mkdir -p openwrt

        # ä¸‹è½½å¹¶è§£å‹
        echo "ğŸ”— ä¸‹è½½åœ°å€: ${SDK_BASE_URL}${SDK_FILE}"
        wget \
          --tries=3 \
          --progress=bar:force:noscroll \
          --continue \
          "${SDK_BASE_URL}${SDK_FILE}" \
          -O openwrt-sdk.tar.xz

        # è§£å‹å‰æ ¡éªŒ
        if ! tar -tvJf openwrt-sdk.tar.xz > /dev/null; then
          echo "::error::âŒ å‹ç¼©åŒ…æ ¡éªŒå¤±è´¥"
          exit 2
        fi

        # æ‰§è¡Œè§£å‹ï¼ˆæ˜ç¡®æŒ‡å®šè¾“å‡ºç›®å½•ï¼‰
        tar -xJf openwrt-sdk.tar.xz \
          --strip-components=1 \
          -C openwrt

        # éªŒè¯è§£å‹ç»“æœ
        if [ ! -f "openwrt/include/kernel-version.mk" ]; then
          echo "::error::âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±ï¼Œè§£å‹å¤±è´¥"
          exit 3
        fi

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f openwrt-sdk.tar.xz
        echo "âœ… SDK å‡†å¤‡å°±ç»ªï¼Œç›®å½•å¤§å°: $(du -sh openwrt | cut -f1)"

    - name: å‡†å¤‡æ’ä»¶æºç 
      working-directory: openwrt/package
      run: |
        git clone --depth 1 --branch master https://github.com/vernesong/OpenClash.git ${{ env.PLUGIN_NAME }}
        
        cd ${{ env.PLUGIN_NAME }}/luci-app-openclash

        # ä¿®å¤ Makefile æ ¼å¼
        sed -i -e 's/^    /\t/g' -e 's/\r$//' Makefile

        # ä¸¥æ ¼ç¼©è¿›éªŒè¯
        if grep -q '^    ' Makefile; then
          echo "::error::âŒ æ£€æµ‹åˆ°æœªè½¬æ¢çš„ç©ºæ ¼ç¼©è¿›"
          exit 1
        fi

        # é¢„ç½® mihomo å†…æ ¸
        CORE_DIR="files/etc/openclash/core"
        mkdir -p $CORE_DIR
        ARCH=${{ steps.parse_target.outputs.ARCH }}

        CORE_URLS=(
          "https://github.com/MetaCubeX/mihomo/releases/download/${{ github.event.inputs.clash_core_version }}/mihomo-linux-$ARCH-${{ github.event.inputs.clash_core_version }}.gz"
          "https://github.com/MetaCubeX/mihomo/releases/download/${{ github.event.inputs.clash_core_version }}/mihomo-linux-$ARCH.gz"
        )

        for url in "${CORE_URLS[@]}"; do
          echo "ğŸ” å°è¯•ä¸‹è½½: $url"
          if curl --output /dev/null --silent --head --fail "$url"; then
            echo "âœ… æœ‰æ•ˆé“¾æ¥: $url"
            wget -q --show-progress "$url" -O clash.gz
            if gunzip -t clash.gz; then
              gunzip clash.gz
              mv clash $CORE_DIR/
              chmod 755 $CORE_DIR/clash
              echo "ğŸ‰ å†…æ ¸éƒ¨ç½²æˆåŠŸ"
              break
            else
              echo "âš ï¸ å‹ç¼©åŒ…æŸåï¼Œå°è¯•ä¸‹ä¸€ä¸ªé“¾æ¥..."
              rm -f clash.gz
            fi
          fi
        done

        # ç¦ç”¨è‡ªåŠ¨æ›´æ–°
        sed -i -e 's/option auto_update .*/option auto_update "0"/' \
               -e 's/option release_branch .*/option release_branch "disabled"/' root/etc/config/openclash

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      working-directory: openwrt
      run: |
        cat << EOF > .config
        CONFIG_TARGET_$(echo ${{ github.event.inputs.target }} | tr '/a-z' '_A-Z')=y
        CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m
        CONFIG_PACKAGE_dnsmasq-full=y
        CONFIG_PACKAGE_iptables-mod-tproxy=y
        CONFIG_PACKAGE_luci-compat=y
        EOF
        
        make defconfig

    - name: æ‰§è¡Œç¼–è¯‘
      working-directory: openwrt
      run: |
        export PATH="$PATH:$GITHUB_WORKSPACE/openwrt/staging_dir/host/bin"
        make -j$(($(nproc) + 1)) package/${{ env.PLUGIN_NAME }}/compile V=s

    - name: æ‰“åŒ…è¾“å‡º
      run: |
        ARTIFACT_DIR="openclash_${{ steps.parse_target.outputs.TARGET_DASH }}_${{ github.event.inputs.firmware_version }}_${{ github.event.inputs.clash_core_version }}"
        mkdir -p $ARTIFACT_DIR
        find openwrt/bin/packages -name "luci-app-openclash*.ipk" -exec cp -v {} $ARTIFACT_DIR/ \;

    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openclash-packages
        path: openclash_*/*.ipk

    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: openclash-${{ steps.parse_target.outputs.TARGET_DASH }}-${{ github.event.inputs.firmware_version }}
        name: OpenClash ${{ github.event.inputs.clash_core_version }} (${{ github.event.inputs.target }})
        body: |
          ### ç¼–è¯‘ä¿¡æ¯
          - â€‹**ç›®æ ‡æ¶æ„**: `${{ github.event.inputs.target }}`
          - â€‹**OpenWrt ç‰ˆæœ¬**: ${{ github.event.inputs.firmware_version }}
          - â€‹**mihomo ç‰ˆæœ¬**: ${{ github.event.inputs.clash_core_version }}
          - â€‹**ç¼–è¯‘æ—¶é—´**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          ### å®‰è£…è¯´æ˜
          ```bash
          opkg install luci-app-openclash_*.ipk
          /etc/init.d/openclash start
          ```
        files: openclash_*/*.ipk
