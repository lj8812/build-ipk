name: 编译 OpenClash 插件

on:
  workflow_dispatch:
    inputs:
      target:
        description: '目标架构 (格式：x86/64 或 armvirt/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrt 版本号'
        required: true
        default: '23.05.5'
      clash_core_version:
        description: 'Clash.Meta 内核版本 (带 v 前缀)'
        required: true
        default: 'v1.18.0'

env:
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 60

    steps:
    - name: 检出仓库
      uses: actions/checkout@v4

    - name: 安装依赖工具链
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 \
          python3-distutils python3-setuptools unzip wget rsync subversion \
          swig time xsltproc zlib1g-dev tree jq

    - name: 设置 Python 环境
      run: |
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        python --version

    - name: 解析目标参数
      id: parse_target
      run: |
        # 转换架构格式 x86/64 → x86-64
        TARGET_SLUG=$(echo "${{ github.event.inputs.target }}" | sed 's/\//-/g')
        echo "TARGET_SLUG=$TARGET_SLUG" >> $GITHUB_OUTPUT
        
        # 提取架构类型
        case "${{ github.event.inputs.target }}" in
          "x86/64")   ARCH_TYPE="amd64"  ;;
          "armvirt/64") ARCH_TYPE="arm64" ;;
          *)
            echo "::error::不支持的架构类型"
            exit 1
            ;;
        esac
        echo "ARCH_TYPE=$ARCH_TYPE" >> $GITHUB_OUTPUT

    - name: 下载 OpenWrt SDK
      run: |
        SDK_BASE="https://downloads.openwrt.org/releases/${{ github.event.inputs.firmware_version }}/targets/${{ github.event.inputs.target }}/"
        echo "🛠️ SDK 下载目录: $SDK_BASE"

        # 动态生成匹配模式
        case "${{ github.event.inputs.target }}" in
          "x86/64")
            PATTERN='openwrt-sdk-.*-x86-64.*\.tar\.xz'
            ;;
          "armvirt/64")
            PATTERN='openwrt-sdk-.*-armvirt-64.*\.tar\.xz'
            ;;
        esac

        # 提取 SDK 文件名
        SDK_FILE=$(curl -s "$SDK_BASE" | grep -oP "$PATTERN" | head -n1)
        echo "🔍 匹配到的 SDK 文件: $SDK_FILE"

        # 下载并解压
        wget --progress=dot:giga "${SDK_BASE}${SDK_FILE}" -O openwrt-sdk.tar.xz
        mkdir -p openwrt
        tar -xJf openwrt-sdk.tar.xz -C openwrt --strip-components 1

    - name: 准备插件源码
      working-directory: openwrt/package
      run: |
        git clone --depth 1 https://github.com/lj8812/OpenClash ${{ env.PLUGIN_NAME }}
        
        cd ${{ env.PLUGIN_NAME }}/luci-app-openclash
        sed -i 's/^    /\t/g' Makefile
        sed -i 's/\r$//' Makefile

        # 预置 Clash.Meta 内核
        mkdir -p files/etc/openclash/core
        CORE_URL="https://github.com/MetaCubeX/Clash.Meta/releases/download/${{ github.event.inputs.clash_core_version }}/clash.meta-linux-${{ steps.parse_target.outputs.ARCH_TYPE }}.gz"
        
        # 备用链接检测
        if ! wget -q --spider "$CORE_URL"; then
          ALT_CORE_URL="https://github.com/MetaCubeX/Clash.Meta/releases/download/${{ github.event.inputs.clash_core_version }}/clash.meta-${{ steps.parse_target.outputs.ARCH_TYPE }}.gz"
          echo "⚠️ 使用备用链接: $ALT_CORE_URL"
          CORE_URL="$ALT_CORE_URL"
        fi

        wget -q --show-progress "$CORE_URL" -O clash.gz
        gunzip clash.gz
        mv clash files/etc/openclash/core/
        chmod +x files/etc/openclash/core/clash

        # 禁用自动更新
        sed -i 's/option auto_update .*/option auto_update "0"/' root/etc/config/openclash
        sed -i 's/option release_branch .*/option release_branch "disabled"/' root/etc/config/openclash

    - name: 配置编译环境
      working-directory: openwrt
      run: |
        TARGET_CONFIG="CONFIG_TARGET_$(echo '${{ github.event.inputs.target }}' | tr / _)"
        echo "$TARGET_CONFIG=y" > .config
        echo "CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-tproxy=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        make defconfig

    - name: 执行编译
      working-directory: openwrt
      run: |
        export PATH=$PATH:$GITHUB_WORKSPACE/openwrt/staging_dir/host/bin
        make -j$(nproc) package/${{ env.PLUGIN_NAME }}/compile V=s

    - name: 生成时间戳
      id: get_timestamp
      run: echo "DATE=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: 打包输出文件
      run: |
        mkdir -p artifacts
        find openwrt/bin/packages -name "${{ env.PLUGIN_NAME }}*.ipk" -exec cp -v {} artifacts/ \;
        
        cd artifacts
        for f in *.ipk; do
          NEW_NAME="openclash_${{ steps.parse_target.outputs.TARGET_SLUG }}_${{ github.event.inputs.firmware_version }}_${{ github.event.inputs.clash_core_version }}.ipk"
          mv "$f" "$NEW_NAME"
        done

    - name: 上传制品
      uses: actions/upload-artifact@v4
      with:
        name: openclash-packages
        path: artifacts/*.ipk
        retention-days: 7

    - name: 创建 GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/*.ipk
        tag_name: openclash-${{ steps.parse_target.outputs.TARGET_SLUG }}-${{ github.event.inputs.firmware_version }}-${{ github.event.inputs.clash_core_version }}
        name: OpenClash ${{ github.event.inputs.clash_core_version }} (${{ github.event.inputs.target }})
        body: |
          ### 📦 编译信息
          - ​**目标架构**: `${{ github.event.inputs.target }}`
          - ​**OpenWrt 版本**: `${{ github.event.inputs.firmware_version }}`
          - ​**Clash.Meta 版本**: `${{ github.event.inputs.clash_core_version }}`
          - ​**编译时间**: `${{ steps.get_timestamp.outputs.DATE }}`

          ### ⚠️ 重要说明
          - 预置 [Clash.Meta](https://github.com/MetaCubeX/Clash.Meta) 内核
          - 默认禁用自动更新
          - 支持 TCP/UDP 流量透明代理
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
