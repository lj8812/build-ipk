name: OpenClash AutoBuilder (Stable)

on:
  # è§¦å‘æ¡ä»¶ï¼šä»»ä½•.ymlæ–‡ä»¶å˜æ›´æ—¶è§¦å‘
  push:
    paths:
      - '**.yml'
      - '**.yaml'
    branches: [ "main", "master" ]

  # ä¿ç•™æ‰‹åŠ¨è§¦å‘åŠŸèƒ½
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æž¶æž„ (ç¤ºä¾‹: x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core:
        description: 'Mihomoæ ¸å¿ƒç‰ˆæœ¬ (å¸¦vå‰ç¼€)'
        required: true
        default: 'v1.18.0'

env:
  BUILD_DIR: ${{ github.workspace }}/openwrt-build
  PLUGIN_NAME: luci-app-openclash
  CACHE_DIR: ${{ runner.temp }}/sdk_cache
  MIRROR_LIST: >
    https://downloads.openwrt.org,
    https://mirror.sjtu.edu.cn/openwrt,
    https://mirrors.tuna.tsinghua.edu.cn/openwrt,
    https://openwrt.proxy.ustclug.org

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    strategy:
      matrix:
        arch: [ 'x86/64', 'arm/armv7' ]  # å¯æ‰©å±•å…¶ä»–æž¶æž„

    steps:
    # --------------------- åˆå§‹åŒ–é˜¶æ®µ ---------------------
    - name: ðŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ðŸ“¥ å®‰è£…åŸºç¡€ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          aria2 xz-utils jq python3 python3-pip \
          libssl-dev zlib1g-dev ccache

    # --------------------- ç¼“å­˜ç®¡ç† ---------------------
    - name: ðŸ—ƒï¸ SDKç¼“å­˜ç®¡ç†
      uses: actions/cache@v3
      with:
        path: ${{ env.CACHE_DIR }}
        key: sdk-${{ matrix.arch }}-${{ inputs.firmware_version }}-v6
        restore-keys: |
          sdk-${{ matrix.arch }}-${{ inputs.firmware_version }}-
          sdk-${{ matrix.arch }}-

    # --------------------- æ ¸å¿ƒä¸‹è½½é˜¶æ®µ ---------------------
    - name: ðŸŒ æ™ºèƒ½ä¸‹è½½SDK
      id: download_sdk
      run: |
        # å‚æ•°æž„é€ 
        TARGET_PATH="${matrix.arch//\//-}"
        FW_VER="${{ inputs.firmware_version }}"
        CACHE_FILE="${{ env.CACHE_DIR }}/sdk_${TARGET_PATH}_${FW_VER}.tar.xz"

        # å¤šæºä¸‹è½½å‡½æ•°
        download_with_retry() {
          local url_pattern="$1"
          for mirror in ${MIRROR_LIST//,/ }; do
            full_url="${mirror}/releases/${FW_VER}/targets/${matrix.arch}/${url_pattern}"
            echo "ðŸ”„ å°è¯•ä¸‹è½½: $full_url"
            if aria2c -x8 -s8 -k1M --retry-wait=30 --file-allocation=none -o sdk_temp.tar.xz "$full_url"; then
              if xz -tvv sdk_temp.tar.xz; then
                mv sdk_temp.tar.xz "$CACHE_FILE"
                echo "âœ… ä¸‹è½½æˆåŠŸ: ${full_url##*/}"
                return 0
              fi
            fi
          done
          return 1
        }

        # å°è¯•å¤šç§æ–‡ä»¶åæ¨¡å¼
        patterns=(
          "openwrt-sdk-${FW_VER}-${TARGET_PATH}_*"
          "openwrt-sdk-${FW_VER%.*}-*-${TARGET_PATH}_*"
        )

        for pattern in "${patterns[@]}"; do
          download_with_retry "$pattern" && break
        done || {
          echo "::error::æ‰€æœ‰é•œåƒæºå‡å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº..."
          ghproxy_url="https://ghproxy.com/https://github.com/openwrt/sdk/releases/download/${FW_VER}/sdk_${TARGET_PATH}.tar.xz"
          curl -L "$ghproxy_url" -o "$CACHE_FILE" || exit 1
        }

    # --------------------- æž„å»ºå‡†å¤‡ ---------------------
    - name: ðŸ§± å‡†å¤‡æž„å»ºçŽ¯å¢ƒ
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        tar -xJf ${{ env.CACHE_DIR }}/sdk_${matrix.arch//\//-}_${{ inputs.firmware_version }}.tar.xz \
          -C ${{ env.BUILD_DIR }} --strip-components=1

    - name: ðŸ’¾ èŽ·å–æ’ä»¶æºç 
      run: |
        cd ${{ env.BUILD_DIR }}
        git clone --filter=blob:none --branch master \
          https://github.com/vernesong/OpenClash package/${{ env.PLUGIN_NAME }}
        
        # æ ¼å¼ä¿®æ­£
        find package/${{ env.PLUGIN_NAME }} -name Makefile -exec sed -i 's/^    /\t/g' {} +

    # --------------------- ç¼–è¯‘é˜¶æ®µ ---------------------
    - name: âš™ï¸ é…ç½®ç¼–è¯‘å‚æ•°
      run: |
        cd ${{ env.BUILD_DIR }}
        cat > .config <<EOF
        CONFIG_TARGET_${matrix.arch##*/}_DEVICE_generic=y
        CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        make defconfig

    - name: ðŸ­ æ‰§è¡Œç¼–è¯‘
      run: |
        cd ${{ env.BUILD_DIR }}
        make -j$(($(nproc) + 2)) \
          V=sc \
          CONFIG_SDK=y \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          package/${{ env.PLUGIN_NAME }}/compile

    # --------------------- å‘å¸ƒé˜¶æ®µ ---------------------
    - name: ðŸš€ å‘å¸ƒåˆ¶å“
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.BUILD_DIR }}/bin/packages/**/*.ipk
        tag_name: openclash-${{ inputs.clash_core }}-$(date +%Y%m%d)
        name: OpenClash ${{ inputs.clash_core }} Build
        body: |
          ### æž„å»ºä¿¡æ¯
          - â€‹**æž¶æž„**: ${{ matrix.arch }}
          - â€‹**å›ºä»¶ç‰ˆæœ¬**: ${{ inputs.firmware_version }}
          - â€‹**æ ¸å¿ƒç‰ˆæœ¬**: ${{ inputs.clash_core }}
          - â€‹**ç¼–è¯‘æ—¶é—´**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          ### SHA256æ ¡éªŒ
          ```bash
          $(sha256sum ${{ env.BUILD_DIR }}/bin/packages/**/*.ipk)
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # --------------------- é”™è¯¯å¤„ç† ---------------------
    - name: ðŸš¨ å¤±è´¥é€šçŸ¥
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸš¨ æž„å»ºå¤±è´¥! è¯¦ç»†ä¿¡æ¯:\n
              Job: ${context.job}\n
              é”™è¯¯æ­¥éª¤: ${{ join(toJson(steps.*.conclusion)) }}\n
              æ—¥å¿—: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          })
