name: OpenClash AutoBuild (Enhanced)

on:
  push:
    branches: [ "main", "dev" ]
    paths:
      - 'luci-app-openclash/Makefile'
  workflow_dispatch:

env:
  PLUGIN_NAME: luci-app-openclash
  TARGET_ARCH: x86/64
  SDK_VERSION: 23.05.5

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    # ===================== åˆå§‹åŒ–çŽ¯å¢ƒ =====================
    - name: ðŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº
      run: |
        BUILD_DIR="${{ github.workspace }}/openwrt-build"
        mkdir -p $BUILD_DIR
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

    # ===================== å®‰è£…ä¾èµ– =====================
    - name: ðŸ“¥ å®‰è£…ç¼–è¯‘å·¥å…·é“¾
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          aria2 xz-utils ccache \
          build-essential git python3 \
          libncurses-dev zlib1g-dev \
          lua5.1 liblua5.1-0-dev lua-filesystem

    # ===================== èŽ·å–ç‰ˆæœ¬ä¿¡æ¯ =====================
    - name: ðŸ” æå–ç‰ˆæœ¬å·
      run: |
        NEW_VERSION=$(grep 'PKG_VERSION:=' ./${{ env.PLUGIN_NAME }}/Makefile | cut -d= -f2)
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "å½“å‰ç‰ˆæœ¬: $NEW_VERSION"

    # ===================== å¤šæºä¸‹è½½SDK =====================
    - name: ðŸŒ ä¸‹è½½OpenWrt SDK
      run: |
        SAFE_TARGET="${TARGET_ARCH//\//-}"
        SDK_FILE="openwrt-sdk-${SDK_VERSION}-${SAFE_TARGET}_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        
        MIRRORS=(
          "https://downloads.openwrt.org/releases/${SDK_VERSION}/targets/${TARGET_ARCH}/${SDK_FILE}"
          "https://mirror.ghproxy.com/https://downloads.openwrt.org/releases/${SDK_VERSION}/targets/${TARGET_ARCH}/${SDK_FILE}"
          "https://op.supes.top/${SDK_FILE}"
        )

        for url in "${MIRRORS[@]}"; do
          echo "ðŸ”— å°è¯•ä¸‹è½½: $url"
          if aria2c -x8 -s8 -d "$BUILD_DIR" -o "$SDK_FILE" "$url"; then
            if xz -t "$BUILD_DIR/$SDK_FILE"; then
              echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡"
              exit 0
            fi
            rm -f "$BUILD_DIR/$SDK_FILE"
          fi
        done

        echo "::error::âŒ æ‰€æœ‰ä¸‹è½½æºå‡ä¸å¯ç”¨"
        exit 1

    # ===================== å‡†å¤‡ç¼–è¯‘çŽ¯å¢ƒ =====================
    - name: ðŸ’» è§£åŽ‹SDK
      run: |
        tar -xJf "$BUILD_DIR/openwrt-sdk-${SDK_VERSION}-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz" \
          -C $BUILD_DIR --strip-components=1

    # ===================== æž„å»ºæ ¸å¿ƒå·¥å…· =====================
    - name: ðŸ”§ ç¼–è¯‘po2lmo
      run: |
        git clone --depth 1 https://github.com/openwrt/luci $BUILD_DIR/luci
        gcc -o $BUILD_DIR/staging_dir/host/bin/po2lmo \
          $BUILD_DIR/luci/modules/luci-base/src/po2lmo.c \
          $BUILD_DIR/luci/modules/luci-base/src/sfh.c
        echo "âœ… po2lmo è·¯å¾„: $(which po2lmo)"

    # ===================== ç¼–è¯‘æ’ä»¶ =====================
    - name: ðŸ­ ç¼–è¯‘OpenClash
      run: |
        cd $BUILD_DIR
        cp -rf ../${{ env.PLUGIN_NAME }} package/
        
        # ä¿®å¤Makefileæ ¼å¼
        find package/${{ env.PLUGIN_NAME }} -name Makefile -exec sed -i 's/^    /\t/g' {} +
        
        # ç”Ÿæˆé…ç½®
        cat > .config <<EOF
        CONFIG_TARGET_x86_64=y
        CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        
        # æ‰§è¡Œç¼–è¯‘
        make defconfig
        make -j$(($(nproc) + 2)) V=sc \
          CONFIG_DEBUG_SECTION_MISMATCH=y \
          package/${{ env.PLUGIN_NAME }}/compile

    # ===================== å‘å¸ƒç®¡ç† =====================
    - name: ðŸš€ å‘å¸ƒç‰ˆæœ¬
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.BUILD_DIR }}/bin/packages/**/*.ipk
        tag_name: v${{ env.NEW_VERSION }}
        name: OpenClash ${{ env.NEW_VERSION }}
        body: |
          ### æž„å»ºä¿¡æ¯
          - â€‹**æž¶æž„**: ${{ env.TARGET_ARCH }}
          - â€‹**SDKç‰ˆæœ¬**: ${{ env.SDK_VERSION }}
          - â€‹**ç¼–è¯‘æ—¶é—´**: `$(date -u +"%Y-%m-%dT%H:%M:%SZ")`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ===================== é”™è¯¯å¤„ç† =====================
    - name: ðŸš¨ å¤±è´¥é€šçŸ¥
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `âš ï¸ ç¼–è¯‘å¤±è´¥ï¼é”™è¯¯æ—¥å¿—ï¼š\n${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          })
