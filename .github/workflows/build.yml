name: 编译 OpenClash 插件

on:
  workflow_dispatch:
    inputs:
      target:
        description: '目标架构 (x86/64 或 armvirt/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrt 版本 (如 23.05.5)'
        required: true
        default: '23.05.5'
      clash_core_version:
        description: 'mihomo 内核版本 (带 v 前缀)'
        required: true
        default: 'v1.18.0'

env:
  PLUGIN_NAME: luci-app-openclash

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 90

    steps:
    - name: 检出仓库
      uses: actions/checkout@v4

    - name: 安装依赖工具链
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 \
          python3-distutils python3-setuptools unzip wget rsync subversion \
          swig time xsltproc zlib1g-dev tree jq lua5.1 lua5.1-dev

    - name: 设置 Python 环境
      run: |
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        python --version

    - name: 解析目标参数
      id: parse_target
      run: |
        TARGET_DASH=$(echo "${{ github.event.inputs.target }}" | sed 's/\//-/g')
        echo "TARGET_DASH=$TARGET_DASH" >> $GITHUB_OUTPUT
        
        case "${{ github.event.inputs.target }}" in
          "x86/64")    ARCH="amd64"  ;;
          "armvirt/64") ARCH="arm64" ;;
          *) echo "::error::不支持的架构"; exit 1 ;;
        esac
        echo "ARCH=$ARCH" >> $GITHUB_OUTPUT

    - name: 下载 OpenWrt SDK
      run: |
        SDK_BASE_URL="https://downloads.openwrt.org/releases/${{ github.event.inputs.firmware_version }}/targets/${{ github.event.inputs.target }}/"
        SDK_FILE=$(curl -s "$SDK_BASE_URL" | grep -oP "openwrt-sdk-.*?-${{ steps.parse_target.outputs.TARGET_DASH }}_gcc-.*?Linux-x86_64.tar.xz" | head -n1)

        mkdir -p openwrt
        wget --tries=3 "${SDK_BASE_URL}${SDK_FILE}" -O openwrt-sdk.tar.xz
        tar -xJf openwrt-sdk.tar.xz -C openwrt --strip-components 1
        rm openwrt-sdk.tar.xz

    - name: 配置编译环境
      working-directory: openwrt
      run: |
        # 更新 feeds 确保 luci-base 可用
        ./scripts/feeds update -a
        ./scripts/feeds install -a luci

        cat << EOF > .config
        CONFIG_TARGET_$(echo ${{ github.event.inputs.target }} | tr '/a-z' '_A-Z')=y
        CONFIG_PACKAGE_${{ env.PLUGIN_NAME }}=m
        CONFIG_PACKAGE_dnsmasq-full=y
        CONFIG_PACKAGE_iptables-mod-tproxy=y
        CONFIG_PACKAGE_luci-compat=y
        CONFIG_PACKAGE_luci-base=y  # 关键配置
        EOF
        
        make defconfig

    - name: 执行编译
      working-directory: openwrt
      run: |
        # 添加 SDK 工具链路径
        export PATH="$PATH:$GITHUB_WORKSPACE/openwrt/staging_dir/host/bin"
        
        # 验证 po2lmo 可用性
        if ! command -v po2lmo &> /dev/null; then
          echo "::error::po2lmo 未找到，请检查 feeds 配置"
          exit 1
        fi

        make -j$(($(nproc) + 1)) package/${{ env.PLUGIN_NAME }}/compile V=s

    - name: 打包输出
      run: |
        ARTIFACT_DIR="openclash_${{ steps.parse_target.outputs.TARGET_DASH }}_${{ github.event.inputs.firmware_version }}_${{ github.event.inputs.clash_core_version }}"
        mkdir -p $ARTIFACT_DIR
        find openwrt/bin/packages -name "luci-app-openclash*.ipk" -exec cp -v {} $ARTIFACT_DIR/ \;

    - name: 上传制品
      uses: actions/upload-artifact@v4
      with:
        name: openclash-packages
        path: openclash_*/*.ipk
