name: OpenClash AutoBuild (Auto-Trigger)

on:
  # è‡ªåŠ¨è§¦å‘æ¡ä»¶
  push:
    branches: [ "main", "master" ]
    paths:
      - 'package/**'
      - '!**.md'
  
  # æ¯å‘¨ä¸€ä¸­åˆ12ç‚¹è‡ªåŠ¨æ„å»º (UTCæ—¶é—´)
  schedule:
    - cron: '0 12 * * 1'

  # æ‰‹åŠ¨è§¦å‘é…ç½®
  workflow_dispatch:
    inputs:
      target:
        description: 'ç›®æ ‡æ¶æ„ (ç¤ºä¾‹: x86/64)'
        required: true
        default: 'x86/64'
      firmware_version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05.5'
      clash_core:
        description: 'Mihomoæ ¸å¿ƒç‰ˆæœ¬ (å¸¦vå‰ç¼€)'
        required: true
        default: 'v1.18.0'

env:
  BUILD_DIR: ${{ github.workspace }}/openwrt-build
  PLUGIN_NAME: luci-app-openclash
  AUTO_MODE: ${{ github.event_name != 'workflow_dispatch' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - name: ğŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº
      if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
      run: |
        mkdir -p $BUILD_DIR
        echo "BUILD_TIMESTAMP=$(date +%s)" >> $GITHUB_ENV

    # å‚æ•°è‡ªåŠ¨æ£€æµ‹é€»è¾‘
    - name: ğŸ” è‡ªåŠ¨æ£€æµ‹å‚æ•°
      if: ${{ env.AUTO_MODE == 'true' }}
      run: |
        # ä»commit messageä¸­æå–å‚æ•°
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        
        # æ¶æ„æ£€æµ‹
        if [[ "$COMMIT_MSG" =~ \[ARM ]]; then
          echo "TARGET=arm/armv7" >> $GITHUB_ENV
        elif [[ "$COMMIT_MSG" =~ \[RISCV ]]; then
          echo "TARGET=riscv/64" >> $GITHUB_ENV
        else
          echo "TARGET=x86/64" >> $GITHUB_ENV
        fi

        # ç‰ˆæœ¬æ£€æµ‹
        if [[ "$COMMIT_MSG" =~ FW_VER=[0-9]+\.[0-9]+\.[0-9]+ ]]; then
          echo "FIRMWARE_VER=${BASH_REMATCH[0]#*=}" >> $GITHUB_ENV
        else
          echo "FIRMWARE_VER=23.05.5" >> $GITHUB_ENV
        fi

        if [[ "$COMMIT_MSG" =~ CORE_VER=v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
          echo "CORE_VER=${BASH_REMATCH[0]}" >> $GITHUB_ENV
        else
          echo "CORE_VER=v1.18.0" >> $GITHUB_ENV
        fi

    # æ‰‹åŠ¨æ¨¡å¼å‚æ•°å¤„ç†
    - name: ğŸ“ è·å–æ‰‹åŠ¨è¾“å…¥
      if: ${{ env.AUTO_MODE == 'false' }}
      run: |
        echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV
        echo "FIRMWARE_VER=${{ github.event.inputs.firmware_version }}" >> $GITHUB_ENV
        echo "CORE_VER=${{ github.event.inputs.clash_core }}" >> $GITHUB_ENV

    # å…¬å…±æ„å»ºæµç¨‹
    - name: ğŸ“¦ ä¸‹è½½SDK
      run: |
        SDK_BASE="https://downloads.openwrt.org/releases/${{ env.FIRMWARE_VER }}/targets/${{ env.TARGET }}"
        
        # æ™ºèƒ½SDKæ£€æµ‹
        SDK_FILE=$(
          curl -sfL "$SDK_BASE/" | 
          grep -oE 'openwrt-sdk-[^"]+Linux-x86_64\.tar\.xz' |
          sort -V | tail -1
        ) || echo "::warning::ä½¿ç”¨å¤‡ç”¨åŒ¹é…æ–¹æ¡ˆ"

        [ -z "$SDK_FILE" ] && SDK_FILE="openwrt-sdk-${{ env.FIRMWARE_VER }}-$(echo ${{ env.TARGET }} | tr '/' '-')_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        
        echo "ğŸ”— SDKä¸‹è½½åœ°å€: $SDK_BASE/$SDK_FILE"
        curl --retry 3 --retry-all-errors -fL -o sdk.tar.xz "$SDK_BASE/$SDK_FILE"
        
        # æ–‡ä»¶éªŒè¯
        {
          echo "ğŸ”¬ æ–‡ä»¶ç±»å‹æ£€æŸ¥..." &&
          file -b sdk.tar.xz | grep "XZ compressed data" &&
          echo "ğŸ§ª å®Œæ•´æ€§éªŒè¯..." &&
          xz -tvv sdk.tar.xz
        } || {
          echo "::error::æ–‡ä»¶éªŒè¯å¤±è´¥"
          exit 1
        }

        tar -xJf sdk.tar.xz -C $BUILD_DIR --strip-components=1
        rm -f sdk.tar.xz

    - name: ğŸ’¾ å‡†å¤‡æ’ä»¶æºç 
      run: |
        cd $BUILD_DIR
        git clone --depth 1 --branch ${{ github.ref_name || 'master' }} \
          https://github.com/vernesong/OpenClash package/$PLUGIN_NAME
        
        # è‡ªåŠ¨ä¿®å¤Makefile
        cd package/$PLUGIN_NAME/$PLUGIN_NAME
        sed -i 's/^    /\t/g' Makefile
        [ -f "Makefile" ] || { echo "::error::Makefileç¼ºå¤±"; exit 1; }

    - name: âš™ï¸ é¢„ç½®æ ¸å¿ƒæ–‡ä»¶
      run: |
        CORE_DIR="$BUILD_DIR/package/$PLUGIN_NAME/$PLUGIN_NAME/files/etc/openclash/core"
        mkdir -p $CORE_DIR
        
        # å¤šé•œåƒæºä¸‹è½½
        MIRRORS=(
          "https://github.com/MetaCubeX/mihomo/releases/download/${{ env.CORE_VER }}/mihomo-linux-$(echo ${{ env.TARGET }} | sed 's/x86\/64/amd64/; s/arm\/armv7/armv7/; s/riscv\/64/riscv64/').gz"
          "https://mirror.ghproxy.com/https://github.com/MetaCubeX/mihomo/releases/download/${{ env.CORE_VER }}/mihomo-linux-$(echo ${{ env.TARGET }} | sed 's/x86\/64/amd64/; s/arm\/armv7/armv7/; s/riscv\/64/riscv64/').gz"
        )

        for url in "${MIRRORS[@]}"; do
          if curl -sfL "$url" | gunzip > "$CORE_DIR/clash"; then
            chmod 755 "$CORE_DIR/clash"
            echo "âœ… æ ¸å¿ƒæ–‡ä»¶ä¸‹è½½æˆåŠŸ: $url"
            break
          fi
        done

        [ -x "$CORE_DIR/clash" ] || { echo "::error::æ ¸å¿ƒæ–‡ä»¶è·å–å¤±è´¥"; exit 1; }

    - name: ğŸ—ï¸ ç¼–è¯‘æ’ä»¶
      run: |
        cd $BUILD_DIR
        cat << EOF > .config
        CONFIG_TARGET_$(echo ${{ env.TARGET }} | tr '/a-z-' 'A-Z_')=y
        CONFIG_PACKAGE_${PLUGIN_NAME}=m
        CONFIG_PACKAGE_luci-compat=y
        EOF
        
        make defconfig
        make -j$(($(nproc) + 2)) V=s package/${PLUGIN_NAME}/compile

    - name: ğŸš€ å‘å¸ƒäº§ç‰©
      uses: softprops/action-gh-release@v2
      with:
        files: |
          $BUILD_DIR/bin/packages/**/*.ipk
        tag_name: openclash-${{ env.CORE_VER }}-$(date +%Y%m%d)
        name: OpenClash ${{ env.CORE_VER }} Build
        body: |
          ### æ„å»ºä¿¡æ¯
          | å‚æ•°          | å€¼                      |
          |---------------|-------------------------|
          | è§¦å‘æ–¹å¼      | ${{ github.event_name }} |
          | ç›®æ ‡æ¶æ„      | ${{ env.TARGET }}       |
          | OpenWrtç‰ˆæœ¬   | ${{ env.FIRMWARE_VER }} |
          | æ ¸å¿ƒç‰ˆæœ¬      | ${{ env.CORE_VER }}     |
          | æ„å»ºæ—¶é—´      | $(date -u +"%Y-%m-%dT%H:%M:%SZ") |

          ### ä½¿ç”¨æŒ‡å—
          1. é€šè¿‡SSHä¸Šä¼ ipkæ–‡ä»¶åˆ°è·¯ç”±å™¨
          2. è¿è¡Œå®‰è£…å‘½ä»¤ï¼š 
             ```bash
             opkg install ./luci-app-openclash_*.ipk
             ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
